<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="theme-color" content="#22C55E">
    <title>Home Solar Potential Explorer | Prototype</title>
    <!-- Fonts: Inter (local first, CDN fallback). If vendor/inter/inter.css is missing, uses CDN. -->
    <link id="interCss" href="vendor/inter/inter.css" rel="stylesheet" onerror="this.onerror=null; this.href='https://rsms.me/inter/inter.css'">

    <!-- TailwindCSS: Prefer local CSS for file:// usage, add CDN fallback below -->
    <link rel="stylesheet" href="vendor/tailwind/tailwind.min.css">
    <script>/* Tailwind CDN fallback for when local CSS missing */</script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide icons: local first, CDN fallback -->
    <script src="vendor/lucide/lucide.min.js" onerror="this.onerror=null; this.src='https://unpkg.com/lucide@latest'"></script>

    <!-- Model Viewer (UMD, non-module): local first, CDN fallback. Works over file:// -->
    <script src="vendor/model-viewer/model-viewer-umd.min.js" onerror="this.onerror=null; this.src='https://cdn.jsdelivr.net/npm/@google/model-viewer@1.12.1/dist/model-viewer-umd.min.js'"></script>
    <style>
      @keyframes roofPulse { 0% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(16,185,129,0.0)); } 50% { transform: scale(1.015); filter: drop-shadow(0 0 6px rgba(16,185,129,0.25)); } 100% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(16,185,129,0.0)); } }
      #roofOverlay .roof-pulse { animation: roofPulse 2.6s ease-in-out infinite; transition: opacity .2s ease; }
      /* Step4 3D 切换过渡效果 */
      #viewer3d model-viewer { transition: opacity .22s ease, transform .22s ease; }
    </style>
  </head>
  <body class="bg-[#FAFFFE] text-gray-800 min-h-screen font-sans" style="font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft Yahei', 'Noto Sans', 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji';">
    <!-- Safe area and app container -->
    <div class="mx-auto max-w-md min-h-screen flex flex-col items-stretch">
      <!-- Top bar -->
      <div class="sticky top-0 z-50 backdrop-blur supports-[backdrop-filter]:bg-white/90 bg-white/90 border-b border-green-100">
        <div class="pt-[10px]"></div>
        <div class="px-3 pb-2">
          <div class="w-full flex items-center gap-2 rounded-2xl px-2 py-1.5 bg-white border border-green-100">
            <div class="flex items-center gap-1.5 pl-0.5">
              <span class="w-2 h-2 rounded-full bg-red-500/80"></span>
              <span class="w-2 h-2 rounded-full bg-amber-500/80"></span>
              <span class="w-2 h-2 rounded-full bg-emerald-500/80"></span>
            </div>
            <div class="flex-1 flex items-center gap-2 px-2">
              <i data-lucide="lock" class="w-4 h-4 text-[#22C55E]"></i>
              <span class="text-[13px] text-gray-600 truncate">https://solar.example.com/explore</span>
            </div>
            <div class="flex items-center gap-1.5 pr-0.5">
              <i data-lucide="rotate-ccw" class="w-4 h-4 text-gray-600"></i>
              <i data-lucide="share" class="w-4 h-4 text-gray-600"></i>
            </div>
          </div>
        </div>
        <!-- Brand + page title -->
        <div class="px-4 pb-3">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-xl bg-[#22C55E]/10 border border-[#22C55E]/20 flex items-center justify-center">
              <span class="text-[15px] tracking-tight font-semibold text-[#22C55E]">S</span>
            </div>
            <div class="flex-1">
              <div class="text-[18px] md:text-[20px] tracking-tight font-semibold text-gray-800">Home Solar Potential Explorer</div>
              <div class="text-[12px] text-gray-600">AI Agent · Get a tailored plan in 60 seconds</div>
            </div>
            <a href="tel:+8618000000000" class="inline-flex items-center gap-1 text-[12px] px-2 py-1 rounded-lg bg-[#22C55E]/10 text-[#22C55E] border border-[#22C55E]/20 hover:bg-[#22C55E]/15 hover:border-[#22C55E]/30 transition">
              <i data-lucide="phone" class="w-3.5 h-3.5"></i>
              <span>Call</span>
            </a>
          </div>
        </div>
      </div>

      <!-- Content -->
      <main class="flex-1 px-3 pb-24">
        <!-- Chat timeline -->
        <div id="chat" class="space-y-3 pt-3"></div>

        <!-- Cards container -->
        <div id="cards" class="space-y-4 mt-4">
          <!-- Step 1: Welcome and address input -->
          <div data-step="1" class="rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden transition-all duration-500">
            <div class="p-4">
              <div class="flex items-center gap-2 text-[12px] text-gray-600">
                <i data-lucide="sun" class="w-4 h-4 text-amber-500"></i>
                <span>Get Started</span>
              </div>
              <h2 class="mt-1 text-[17px] tracking-tight font-semibold text-gray-800">Explore your home's solar potential in 60 seconds</h2>
              <p class="mt-2 text-[13px] leading-5 text-gray-600">
                Enter your address and we'll locate your roof to generate a 3D plan and savings estimate.
              </p>
              <div class="mt-3 space-y-2">
                <div class="relative">
                  <i data-lucide="map-pin" class="w-4.5 h-4.5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                  <input id="addressInput" placeholder="Enter full address, e.g. 221B George St, Sydney NSW" class="w-full pl-10 pr-3 py-3 rounded-xl bg-gray-50 border border-gray-200 text-[14px] placeholder:text-gray-400 focus:outline-none focus:border-[#22C55E] transition">
                </div>
                <div class="flex items-center justify-between">
                  <div class="text-[12px] text-gray-500">Example: 120 Collins St, Melbourne VIC</div>
                  <button id="useLocationBtn" class="inline-flex items-center gap-1.5 text-[12px] px-2 py-1 rounded-lg bg-[#22C55E]/10 text-[#22C55E] border-2 border-[#22C55E] hover:bg-[#22C55E]/15">
                    <i data-lucide="crosshair" class="w-4 h-4"></i> Use current location
                  </button>
                </div>
                <div class="grid grid-cols-2 gap-2 pt-1">
                  <button id="startExploreBtn" class="col-span-2 inline-flex gap-2 hover:bg-[#16A34A] transition active:scale-[0.99] text-white bg-[#22C55E] border-[#22C55E] border rounded-xl pt-2.5 pr-4 pb-2.5 pl-4 items-center justify-center disabled:opacity-40 disabled:cursor-not-allowed" disabled="">
                    <i data-lucide="compass" class="w-4.5 h-4.5"></i>
                    <span class="text-[14px] font-medium">Start exploring</span>
                  </button>
                </div>
                <div id="addrError" class="hidden text-[12px] text-red-500">Please enter a valid address (at least 6 characters)</div>
              </div>
            </div>
          </div>

          <!-- Step 2: Roof confirmation (interactive map) -->
          <div data-step="2" class="hidden rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden transition-all duration-500">
            <div class="p-3">
              <div class="mb-2 flex items-center justify-between">
                <button id="backTo1" class="inline-flex items-center gap-1.5 text-[12px] text-gray-600 px-2 py-1 rounded-lg hover:bg-gray-100 border border-gray-200">
                  <i data-lucide="chevron-left" class="w-4 h-4"></i> Back
                </button>
                <div id="addrLabel" class="text-[12px] text-gray-600 truncate max-w-[65%]"></div>
              </div>
              <div class="relative rounded-xl overflow-hidden border border-green-200 bg-gray-50" style="height: 45vh;">
                <!-- Map viewport -->
                <div id="mapViewport" class="absolute inset-0 touch-pan-y touch-pan-x cursor-grab active:cursor-grabbing">
                  <img id="mapImage" src="Pic/point_523_high.jpg" class="select-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2" style="transform: translate(-50%, -50%) scale(1.6); transform-origin: center center; width: 160%; height: auto;">
                  <!-- Roof highlight -->
                  <svg id="roofOverlay" class="absolute inset-0 pointer-events-none" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
                  <!-- Map HUD -->
                  <div class="absolute top-2 left-2 text-[11px] px-2 py-1 rounded-md bg-gray-100 border border-gray-200">Drag/zoom map, then tap your roof</div>
                  <div class="absolute top-2 right-2 flex flex-col gap-1">
                    <button id="zoomIn" class="h-8 w-8 rounded-lg bg-white/90 border border-gray-200 flex items-center justify-center shadow-sm hover:bg-gray-50"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    <button id="zoomOut" class="h-8 w-8 rounded-lg bg-white/90 border border-gray-200 flex items-center justify-center shadow-sm hover:bg-gray-50"><i data-lucide="minus" class="w-4 h-4"></i></button>
                    <button id="rectSelect" class="h-8 w-8 rounded-lg bg-white/90 border border-gray-200 flex items-center justify-center shadow-sm hover:bg-gray-50"><i data-lucide="crop" class="w-4 h-4"></i></button>
                    <button id="resetView" class="h-8 w-8 rounded-lg bg-white/90 border border-gray-200 flex items-center justify-center shadow-sm hover:bg-gray-50"><i data-lucide="rotate-ccw" class="w-4 h-4"></i></button>
                    <button id="undoAction" class="h-8 w-8 rounded-lg bg-white/90 border border-gray-200 flex items-center justify-center shadow-sm hover:bg-gray-50"><i data-lucide="undo-2" class="w-4 h-4"></i></button>
                  </div>
                </div>
                <!-- Confirm bar -->
                <div class="absolute bottom-0 inset-x-0 p-2 bg-gradient-to-t from-gray-100 to-transparent">
                  <div class="flex items-center gap-2">
                    <div id="roofHint" class="flex-1 text-[12px] text-gray-600">Tap your roof on the map</div>
                    <button id="confirmRoofBtn" class="shrink-0 inline-flex items-center gap-1.5 text-[12px] px-3 py-2 rounded-xl bg-[#22C55E] text-white border border-[#22C55E] hover:bg-[#16A34A] transition disabled:opacity-40 disabled:cursor-not-allowed" disabled="">
                      <i data-lucide="check" class="w-4 h-4"></i> Confirm roof
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 3: AI analysis (enhanced card) -->
          <div data-step="3" class="hidden rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden transition-all duration-500">
            <div class="p-4">
              <div class="flex items-center gap-2 text-[12px] text-gray-600">
                <i data-lucide="sparkles" class="w-4 h-4 text-amber-500"></i>
                <span>Analyzing</span>
              </div>
              <h3 class="mt-1 text-[18px] tracking-tight font-semibold text-gray-800">Smart analysis for your roof</h3>
              <p class="text-[12px] text-gray-600 mt-1">It's like magic!</p>
              <div class="mt-3 rounded-xl border border-gray-200 bg-gray-50 overflow-hidden">
                <div class="w-full" style="aspect-ratio: 16/9;">
                  <img src="Pic/ How the System Works.png" alt="system analysis" class="w-full h-full object-cover">
                </div>
              </div>
              <div class="mt-3 space-y-2 text-[13px]">
                <div id="task1" class="flex items-center gap-2 text-gray-600">
                  <i data-lucide="check-circle" class="w-3.5 h-3.5 text-emerald-500"></i>
                  <span>Analyzing roof area</span>
                </div>
                <div id="task2" class="flex items-center gap-2 text-gray-600">
                  <i data-lucide="check-circle" class="w-3.5 h-3.5 text-emerald-500"></i>
                  <span>Evaluating sun exposure</span>
                </div>
                <div id="task3" class="flex items-center gap-2 text-gray-600">
                  <i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin text-amber-500"></i>
                  <span>Scanning high-consumption devices</span>
                </div>
              </div>
              <div class="mt-2 text-[12px] text-gray-500">This typically takes 5–15 seconds depending on imagery quality.</div>
            </div>
          </div>

          <!-- Step 4: 3D model -->
          <div data-step="4" class="hidden rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden transition-all duration-500">
            <div class="p-3">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2 text-[12px] text-emerald-600">
                  <i data-lucide="check-circle-2" class="w-4.5 h-4.5"></i>
                  <span>Analysis complete</span>
                </div>
                <button id="backTo2" class="inline-flex items-center gap-1.5 text-[12px] text-gray-600 px-2 py-1 rounded-lg hover:bg-gray-100 border border-gray-200">
                  <i data-lucide="chevron-left" class="w-4 h-4"></i> Back
                </button>
              </div>
              <h3 class="text-[18px] tracking-tight font-semibold text-gray-800">Your 3D roof model</h3>
              <div class="mt-2 relative rounded-xl overflow-hidden border border-green-200 bg-gray-50" style="height: 20vh;">
                <!-- 3D Viewer (mock) -->
                <div id="viewer3d" class="absolute inset-0">
                  <model-viewer
                    src="3d/43792833-0cb3-4884-85ef-1fb678777d5c/base_basic_shaded.glb"
                    camera-controls
                    auto-rotate
                    disable-zoom
                    ar
                    style="width:100%;height:100%;background:transparent"
                    class="absolute inset-0"
                  ></model-viewer>
                  <div class="absolute top-2 left-2 text-[11px] px-2 py-1 rounded-md bg-gray-100 border border-gray-200">Drag to rotate</div>
                </div>
              </div>
              <!-- Schemes strip (horizontal) -->
              <div class="mt-3">
                <div class="text-[12px] text-gray-600 mb-2">Based on the analysis, here are 4 tailored plans</div>
                <div id="schemesStrip4" class="flex gap-2 overflow-x-auto no-scrollbar">
                  <button class="scheme-card-mini shrink-0 rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left min-w-[46%]" data-scheme="smart" onclick="window.selectScheme4 && window.selectScheme4('smart')">
                    <div class="flex items-center justify-between">
                      <div class="text-[14px] font-medium text-gray-800">Smart Saver</div>
                      <i data-lucide="zap" class="w-4.5 h-4.5 text-amber-500"></i>
                    </div>
                    <div class="text-[12px] text-gray-600 mt-1">Fewer panels, quick payback</div>
                  </button>
                  <button class="scheme-card-mini shrink-0 rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left min-w-[46%]" data-scheme="efficient" onclick="window.selectScheme4 && window.selectScheme4('efficient')">
                    <div class="flex items-center justify-between">
                      <div class="text-[14px] font-medium text-gray-800">High Efficiency</div>
                      <i data-lucide="gauge" class="w-4.5 h-4.5 text-gray-600"></i>
                    </div>
                    <div class="text-[12px] text-gray-600 mt-1">More generation, higher self-use</div>
                  </button>
                  <button class="scheme-card-mini shrink-0 rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left min-w-[46%]" data-scheme="independence" onclick="window.selectScheme4 && window.selectScheme4('independence')">
                    <div class="flex items-center justify-between">
                      <div class="text-[14px] font-medium text-gray-800">Energy Independence</div>
                      <i data-lucide="battery-charging" class="w-4.5 h-4.5 text-emerald-500"></i>
                    </div>
                    <div class="text-[12px] text-gray-600 mt-1">Battery backup for outages</div>
                  </button>
                  <button class="scheme-card-mini shrink-0 rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left min-w-[46%]" data-scheme="ultimate" onclick="window.selectScheme4 && window.selectScheme4('ultimate')">
                    <div class="flex items-center justify-between">
                      <div class="text-[14px] font-medium text-gray-800">Ultimate Energy</div>
                      <i data-lucide="stars" class="w-4.5 h-4.5 text-amber-500"></i>
                    </div>
                    <div class="text-[12px] text-gray-600 mt-1">Max panels, maximum savings</div>
                  </button>
                </div>
              </div>

              <!-- Budget quote (range) panel in Step 4 -->
              <section id="s4BudgetPanel" class="mt-3 p-2.5 rounded-2xl bg-white border border-green-200 shadow-sm">
                <div class="flex items-center justify-between mb-1">
                  <h3 class="text-[13px] font-semibold text-gray-900">System budget (incl. tax)</h3>
                  <span id="s4BudgetRange" class="text-[16px] font-bold text-[#22C55E]">$0 – $0</span>
                </div>
                <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                  <div class="rounded-xl border border-gray-100 p-2">
                    <div class="text-[10px] text-gray-500">Estimated system size</div>
                    <div id="s4SizeRange" class="text-[12px] font-semibold text-gray-900">–</div>
                  </div>
                  <div class="rounded-xl border border-gray-100 p-2">
                    <div class="text-[10px] text-gray-500">Payback period</div>
                    <div id="s4PaybackRange" class="text-[12px] font-semibold text-gray-900">–</div>
                  </div>
                  <div class="rounded-xl border border-gray-100 p-2">
                    <div class="text-[10px] text-gray-500">Self-consumption</div>
                    <div id="s4SelfUseRange" class="text-[12px] font-semibold text-gray-900">–</div>
                  </div>
                  <div class="rounded-xl border border-gray-100 p-2">
                    <div class="text-[10px] text-gray-500">Annual bill savings</div>
                    <div id="s4AnnualSaveRange" class="text-[12px] font-semibold text-gray-900">–</div>
                  </div>
                </div>
                <p class="text-[10px] text-gray-500 leading-snug mb-1.5">
                  These are preliminary estimates incl. tax, excluding grid connection & subsidy differences. Provide details to receive an accurate quote.
                </p>
                <div class="flex items-center gap-1.5">
                  <button id="s4CopyBtn" class="px-2.5 py-1.5 text-[11px] rounded-xl border border-gray-200 bg-white">Copy</button>
                  <button id="s4ShareBtn" class="px-2.5 py-1.5 text-[11px] rounded-xl border border-gray-200 bg-white">Share</button>
                  <button id="s4SaveImgBtn" class="px-2.5 py-1.5 text-[11px] rounded-xl border border-gray-200 bg-white inline-flex items-center gap-1.5" title="Save image">
                    <i data-lucide="image-down" class="w-3.5 h-3.5"></i>
                    <span>Save image</span>
                  </button>
                  <button id="s4RefineBtn" class="ml-auto px-2.5 py-1.5 text-[11px] rounded-xl bg-[#22C55E] text-white border border-[#22C55E] hover:bg-[#16A34A] transition">Refine info</button>
                </div>
              </section>
            </div>
          </div>

          <!-- Step 5: Plan interaction -->
          <div data-step="5" class="hidden rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden transition-all duration-500">
            <div class="p-3">
              <div class="mb-2 flex items-center justify-between">
                <div class="text-[12px] text-gray-600">Based on the analysis, here are 4 tailored plans</div>
                <button id="backTo4" class="inline-flex items-center gap-1.5 text-[12px] text-gray-600 px-2 py-1 rounded-lg hover:bg-gray-100 border border-gray-200">
                  <i data-lucide="chevron-left" class="w-4 h-4"></i> Back
                </button>
              </div>
              <div class="relative rounded-xl overflow-hidden border border-green-200 bg-gray-50" style="height: 40vh;">
                <!-- Reuse same viewer -->
                <div id="viewer5" class="absolute inset-0">
                  <div class="absolute inset-0">
                    <div class="w-full h-full relative" style="perspective: 900px;">
                      <div id="house3dStep5" class="absolute left-1/2 top-1/2 origin-center -translate-x-1/2 -translate-y-1/2 transition-transform duration-75" style="transform: rotateX(55deg) rotateY(0deg) scale(1);">
                        <div class="relative mx-auto" style="width: 260px; height: 160px;">
                          <div class="absolute inset-x-0 bottom-0 h-[70%] bg-gray-100 border border-green-200 rounded-lg"></div>
                          <div id="roofPlane5" class="absolute left-1/2 -translate-x-1/2 -top-4 w-[260px] h-[120px] bg-gray-200 border border-green-300 rounded-lg" style="transform: skewX(-12deg) rotateX(12deg);">
                            <div id="pvPanels5" class="relative w-full h-full"></div>
                          </div>
                          <div id="batteryWall5" class="absolute right-3 bottom-3 w-[28px] h-[46px] rounded-md bg-emerald-100 border border-emerald-200 hidden flex items-center justify-center">
                            <i data-lucide="battery-charging" class="w-4 h-4 text-emerald-600"></i>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="absolute top-2 left-2 text-[11px] px-2 py-1 rounded-md bg-gray-100 border border-gray-200">Tap a plan below to update the model</div>
                  </div>
                </div>
              </div>
              <!-- Schemes -->
              <div class="mt-3 grid grid-cols-2 gap-2">
                <button class="scheme-card group rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left" data-scheme="smart">
                  <div class="flex items-center justify-between">
                    <div class="text-[14px] font-medium text-gray-800">Smart Saver</div>
                    <i data-lucide="zap" class="w-4.5 h-4.5 text-amber-500 group-hover:text-amber-600"></i>
                  </div>
                  <div class="text-[12px] text-gray-600 mt-1">Fewer panels, quick payback</div>
                </button>
                <button class="scheme-card group rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left" data-scheme="efficient">
                  <div class="flex items-center justify-between">
                    <div class="text-[14px] font-medium text-gray-800">High Efficiency</div>
                    <i data-lucide="gauge" class="w-4.5 h-4.5 text-gray-600"></i>
                  </div>
                  <div class="text-[12px] text-gray-600 mt-1">More generation, higher self-use</div>
                </button>
                <button class="scheme-card group rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left" data-scheme="independence">
                  <div class="flex items-center justify-between">
                    <div class="text-[14px] font-medium text-gray-800">Energy Independence</div>
                    <i data-lucide="battery-charging" class="w-4.5 h-4.5 text-emerald-500"></i>
                  </div>
                  <div class="text-[12px] text-gray-600 mt-1">Battery backup for outages</div>
                </button>
                <button class="scheme-card group rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left" data-scheme="ultimate">
                  <div class="flex items-center justify-between">
                    <div class="text-[14px] font-medium text-gray-800">Ultimate Energy</div>
                    <i data-lucide="stars" class="w-4.5 h-4.5 text-amber-500"></i>
                  </div>
                  <div class="text-[12px] text-gray-600 mt-1">Max panels, maximum savings</div>
                </button>
              </div>
            </div>
          </div>

          <!-- Step 6: Value presentation -->
          <div data-step="6" class="hidden rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden transition-all duration-500">
            <div class="p-3">
              <div class="mb-2 flex items-center justify-between">
                <div class="text-[12px] text-gray-600">Estimated plan value</div>
                <button id="backTo5" class="inline-flex items-center gap-1.5 text-[12px] text-gray-600 px-2 py-1 rounded-lg hover:bg-gray-100 border border-gray-200">
                  <i data-lucide="chevron-left" class="w-4 h-4"></i> View other plans
                </button>
              </div>

              <!-- Saving number -->
              <div class="rounded-xl border border-green-200 bg-gray-50 p-4 text-center">
                <div class="text-[12px] text-gray-600">System budget (incl. tax)</div>
                <div id="savingNumber" class="mt-1 text-[28px] tracking-tight font-semibold text-[#22C55E]">$0 – $0</div>
                <div id="schemeTag" class="mt-1 inline-flex items-center gap-1.5 text-[11px] px-2 py-1 rounded-md bg-gray-100 border border-gray-200 text-gray-600"></div>
              </div>

              <!-- Economic breakdown -->
              <div class="mt-3 rounded-xl border border-green-200 bg-gray-50 p-3">
                <div class="flex items-center justify-between">
                  <div class="text-[12px] text-gray-600">Estimated system size</div>
                  <div id="sizeText" class="text-[14px] font-medium text-gray-800"></div>
                </div>
                <div class="mt-2 flex items-center justify-between">
                  <div class="text-[12px] text-gray-600">Estimated payback period</div>
                  <div id="roiText" class="text-[14px] font-medium text-gray-800"></div>
                </div>
                <div class="mt-2 flex items-center justify-between">
                  <div class="text-[12px] text-gray-600">Self-consumption</div>
                  <div id="selfUseText" class="text-[14px] font-medium text-gray-800"></div>
                </div>
              </div>

              <div class="mt-3 flex items-center justify-end">
                <button id="openLeadBtn" class="inline-flex items-center gap-1.5 text-[12px] px-3 py-2 rounded-xl bg-[#22C55E] text-white border border-[#22C55E] hover:bg-[#16A34A] transition">
                  <i data-lucide="mail" class="w-4 h-4"></i> Get subsidy-inclusive quote
                </button>
              </div>
            </div>
          </div>

          <!-- Step 6A: Quote action card (independent) -->
          <div id="card6A" class="hidden rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden transition-all duration-500">
            <div class="p-3">
              <div class="mb-2 flex items-center justify-between">
                <div class="text-[12px] text-gray-600">Budget quote (range)</div>
                <div class="inline-flex items-center gap-1.5 text-[11px] px-2 py-1 rounded-lg bg-emerald-50 text-emerald-700 border border-emerald-200">
                  <i data-lucide="badge-dollar-sign" class="w-4 h-4"></i>
                  <span>Preliminary</span>
                </div>
              </div>

              <div class="rounded-xl border border-green-200 bg-gray-50 p-3">
                <div class="flex items-center justify-between">
                  <div class="text-[12px] text-gray-600">System budget (incl. tax)</div>
                  <div id="s6a_budget" class="text-[14px] font-semibold text-gray-800"></div>
                </div>
                <div class="mt-2 flex items-center justify-between">
                  <div class="text-[12px] text-gray-600">Payback period</div>
                  <div id="s6a_roi" class="text-[14px] font-medium text-gray-800"></div>
                </div>
                <div class="mt-2 flex items-center justify-between">
                  <div class="text-[12px] text-gray-600">Self-consumption</div>
                  <div id="s6a_selfuse" class="text-[14px] font-medium text-gray-800"></div>
                </div>
                <div class="mt-2 flex items-center justify-between">
                  <div class="text-[12px] text-gray-600">Annual bill savings</div>
                  <div id="s6a_saving" class="text-[14px] font-medium text-[#22C55E]"></div>
                </div>
                <div class="mt-2 text-[11px] text-gray-500 leading-4">
                  These are preliminary estimates incl. tax, excluding grid connection & subsidy differences. Provide details to receive an accurate quote.
                </div>
              </div>

              <div class="mt-3 grid grid-cols-3 gap-2">
                <button id="copyQuoteBtn" class="inline-flex items-center justify-center gap-1.5 text-[12px] px-3 py-2 rounded-xl bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200 transition">
                  <i data-lucide="copy" class="w-4 h-4"></i> Copy quote
                </button>
                <button id="shareQuoteBtn" class="inline-flex items-center justify-center gap-1.5 text-[12px] px-3 py-2 rounded-xl bg-emerald-100 text-emerald-700 border border-emerald-200 hover:bg-emerald-200 transition">
                  <i data-lucide="share-2" class="w-4 h-4"></i> Share
                </button>
                <button id="refineInfoBtn" class="inline-flex items-center justify-center gap-1.5 text-[12px] px-3 py-2 rounded-xl bg-[#22C55E] text-white border border-[#22C55E] hover:bg-[#16A34A] transition">
                  <i data-lucide="edit-3" class="w-4 h-4"></i> Refine info
                </button>
              </div>
            </div>
          </div>

          <!-- Share dialog (modal) -->
          <div id="shareModal" class="hidden fixed inset-0 z-[60]">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
            <div class="absolute inset-x-3 bottom-3 max-w-md mx-auto rounded-2xl bg-white border border-green-200 p-4 shadow-2xl">
              <div class="flex items-start gap-2">
                <div class="flex-1">
                  <div class="text-[12px] text-gray-600">Share with your friends and family</div>
                  <h4 class="text-[18px] tracking-tight font-semibold text-gray-800">Scan to view your interactive proposal</h4>
                  <p class="text-[12px] text-gray-600 mt-1">Want a more precise quote or to understand your STC benefits? Use the link below or contact our installer for an assessment.</p>
                </div>
                <button id="closeShareBtn" class="h-8 w-8 rounded-lg bg-gray-100 border border-gray-200 flex items-center justify-center">
                  <i data-lucide="x" class="w-4 h-4 text-gray-600"></i>
                </button>
              </div>
              <div class="mt-3 space-y-2">
                <div class="rounded-xl border border-gray-200 overflow-hidden bg-gray-50">
                  <img id="shareImg" src="Pic/share card.png" alt="share card" class="w-full h-auto">
                </div>
                <div class="flex items-center gap-2 text-[12px]">
                  <i data-lucide="link" class="w-4 h-4 text-gray-600"></i>
                  <span id="shareUrlText" class="truncate">https://example.com/h5?utm_source=share_card&utm_medium=web&utm_campaign=au_resi_pv_v1_6</span>
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <button id="shareNativeBtn" class="inline-flex items-center justify-center gap-1.5 text-[12px] px-3 py-2 rounded-xl bg-emerald-100 text-emerald-700 border border-emerald-200 hover:bg-emerald-200 transition">
                    <i data-lucide="share-2" class="w-4 h-4"></i> Share
                  </button>
                  <button id="shareCopyBtn" class="inline-flex items-center justify-center gap-1.5 text-[12px] px-3 py-2 rounded-xl bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200 transition">
                    <i data-lucide="copy" class="w-4 h-4"></i> Copy link
                  </button>
                </div>
                <div class="flex items-center justify-between pt-1">
                  <a id="learnStcLink" href="#" class="text-[12px] text-emerald-700 hover:underline inline-flex items-center gap-1">
                    <i data-lucide="info" class="w-4 h-4"></i> Learn STC
                  </a>
                  <button id="shareContactBtn" class="inline-flex items-center gap-1.5 text-[12px] px-3 py-2 rounded-xl bg-[#22C55E] text-white border border-[#22C55E] hover:bg-[#16A34A] transition">
                    <i data-lucide="mail" class="w-4 h-4"></i> Contact installer
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 7: Lead capture (modal) -->
          <!-- Modal overlay -->
          <div id="leadModal" class="hidden fixed inset-0 z-[60]">
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
            <div class="absolute inset-x-3 bottom-3 max-w-md mx-auto rounded-2xl bg-white border border-green-200 p-4 shadow-2xl">
              <div class="flex items-start gap-2">
                <div class="flex-1">
                  <div class="text-[12px] text-gray-600">Secure your subsidy eligibility now</div>
                  <h4 class="text-[18px] tracking-tight font-semibold text-gray-800">Get the final price including subsidies</h4>
                  <p id="subsidyHint" class="text-[12px] text-gray-600 mt-1"></p>
                </div>
                <button id="closeLeadBtn" class="h-8 w-8 rounded-lg bg-gray-100 border border-gray-200 flex items-center justify-center">
                  <i data-lucide="x" class="w-4 h-4 text-gray-600"></i>
                </button>
              </div>
              <div class="mt-3 space-y-2">
                <div class="relative">
                  <i data-lucide="user" class="w-4.5 h-4.5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                  <input id="leadName" placeholder="Name" class="w-full pl-10 pr-3 py-3 rounded-xl bg-gray-50 border border-gray-200 text-[14px] placeholder:text-gray-400 focus:outline-none focus:border-[#22C55E] transition">
                </div>
                <div class="relative">
                  <i data-lucide="mail" class="w-4.5 h-4.5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                  <input id="leadEmail" type="email" placeholder="Email" class="w-full pl-10 pr-3 py-3 rounded-xl bg-gray-50 border border-gray-200 text-[14px] placeholder:text-gray-400 focus:outline-none focus:border-[#22C55E] transition">
                </div>
                <div class="relative">
                  <i data-lucide="phone" class="w-4.5 h-4.5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                  <input id="leadPhone" inputmode="tel" placeholder="Phone" class="w-full pl-10 pr-3 py-3 rounded-xl bg-gray-50 border border-gray-200 text-[14px] placeholder:text-gray-400 focus:outline-none focus:border-[#22C55E] transition">
                </div>
                <div class="relative">
                  <i data-lucide="map-pin" class="w-4.5 h-4.5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                  <input id="leadPostcode" inputmode="numeric" maxlength="4" placeholder="Postcode (for STC estimate)" class="w-full pl-10 pr-3 py-3 rounded-xl bg-gray-50 border border-gray-200 text-[14px] placeholder:text-gray-400 focus:outline-none focus:border-[#22C55E] transition">
                </div>
                <div class="relative">
                  <textarea id="leadNotes" placeholder="Notes (optional): roof type, battery interest, preferred contact time" class="w-full px-3 py-3 rounded-xl bg-gray-50 border border-gray-200 text-[14px] placeholder:text-gray-400 focus:outline-none focus:border-[#22C55E] transition"></textarea>
                </div>
                <label class="flex items-start gap-2 text-[12px] text-gray-600 select-none">
                  <input id="leadConsent" type="checkbox" class="mt-0.5 w-4 h-4 rounded border-gray-300">
                  <span>I agree to be contacted and consent to the privacy policy.</span>
                </label>
                <div id="leadError" class="hidden text-[12px] text-red-500">Please complete at least two of Name/Email/Phone, provide a valid 4-digit postcode and consent.</div>
              </div>
              <div class="mt-3 flex gap-2">
                <button id="submitLeadBtn" class="flex-1 inline-flex items-center justify-center gap-1.5 px-4 py-2.5 rounded-xl bg-[#22C55E] text-white border border-[#22C55E] hover:bg-[#16A34A] transition">
                  <i data-lucide="send" class="w-4.5 h-4.5"></i>
                  <span class="text-[13px]">Submit to receive full report</span>
                </button>
                <a href="tel:+8618000000000" class="px-4 py-2.5 rounded-xl bg-emerald-100 text-emerald-600 border border-emerald-200 hover:bg-emerald-200 transition inline-flex items-center gap-1.5">
                  <i data-lucide="phone-call" class="w-4.5 h-4.5"></i>
                  Call
                </a>
              </div>
            </div>
          </div>

          <!-- Step 7: Submitted successfully -->
          <div data-step="7" class="hidden rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden transition-all duration-500">
            <div class="p-4">
              <div class="flex items-center gap-2 text-[12px] text-emerald-600">
                <i data-lucide="check-circle-2" class="w-4.5 h-4.5"></i>
                <span>Submitted</span>
              </div>
              <h3 class="mt-1 text-[20px] tracking-tight font-semibold text-gray-800">Thanks! We've received your info</h3>
              <p class="text-[13px] text-gray-600 mt-1">
                The full report has been sent to your email. Our consultant will contact you soon. For urgent requests, call us directly.
              </p>
              <div class="mt-3 flex gap-2">
                <a href="tel:+8618000000000" class="flex-1 inline-flex items-center justify-center gap-1.5 px-4 py-2.5 rounded-xl bg-emerald-100 text-emerald-600 border border-emerald-200 hover:bg-emerald-200 transition">
                  <i data-lucide="phone" class="w-4.5 h-4.5"></i>
                  Contact now
                </a>
                <button id="restartBtn" class="flex-1 inline-flex items-center justify-center gap-1.5 px-4 py-2.5 rounded-xl bg-gray-100 text-gray-600 border border-gray-200 hover:bg-gray-200 transition">
                  <i data-lucide="rotate-ccw" class="w-4.5 h-4.5"></i>
                  Restart
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- Bottom shadow gradient -->
      <div class="pointer-events-none fixed bottom-0 left-0 right-0 h-20 bg-gradient-to-t from-gray-100 to-transparent z-40"></div>
    </div>

    <!-- Fixed bottom chat input bar -->
    <div class="fixed inset-x-0 bottom-0 z-50">
      <div class="mx-auto max-w-md px-3 pb-[env(safe-area-inset-bottom)]">
        <div class="mb-2 flex items-center gap-2 rounded-2xl border border-gray-200 bg-white backdrop-blur px-2.5 py-2 shadow-lg">
          <button id="freeChatAttachBtn" class="shrink-0 inline-flex items-center justify-center h-9 w-9 rounded-xl hover:bg-gray-100 border border-gray-200 transition text-gray-600" title="Attach">
            <i data-lucide="plus" class="w-4.5 h-4.5"></i>
          </button>
          <input id="freeChatInput" placeholder="Type a message, press Enter to send..." class="flex-1 h-9 bg-transparent outline-none text-[14px] placeholder:text-gray-400 px-1">
          <button id="freeChatSendBtn" class="shrink-0 inline-flex items-center justify-center h-9 px-3 rounded-xl bg-[#22C55E] text-white border border-[#22C55E] hover:bg-[#16A34A] transition disabled:opacity-40 disabled:cursor-not-allowed" disabled="">
            <i data-lucide="send" class="w-4.5 h-4.5"></i>
            <span class="sr-only">Send</span>
          </button>
        </div>
      </div>
    </div>

    <script>
      // Initialize Lucide icons with stroke width 1.5
      document.addEventListener('DOMContentLoaded', () => {
        if (window.lucide) {
          try { window.lucide.createIcons({ attrs: { 'stroke-width': 1.5 } }); } catch {}
        }
      });
    </script>

    <!-- Debug: model-viewer load/error diagnostics -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const mv = document.querySelector('model-viewer');
        if (!mv) return;
        const statusEl = document.createElement('div');
        statusEl.id = 'mvStatus';
        statusEl.className = 'absolute bottom-2 right-2 text-[10px] px-2 py-1 rounded bg-black/50 text-white';
        statusEl.textContent = '3D: loading...';
        const host = document.getElementById('viewer3d');
        if (host) host.appendChild(statusEl);

        const ok = () => { statusEl.textContent = '3D: loaded'; statusEl.classList.add('bg-emerald-600/80'); };
        const fail = (msg) => { statusEl.textContent = '3D: error'; statusEl.classList.add('bg-red-600/80'); console.error('[model-viewer] error:', msg); };

        mv.addEventListener('load', ok);
        mv.addEventListener('error', (e) => fail(e?.detail || e?.message || e));
        mv.addEventListener('poster-dismissed', () => console.log('[model-viewer] poster dismissed'));

        // If custom element not defined (library not loaded), mark error after a tick
        setTimeout(() => {
          const defined = !!customElements.get('model-viewer');
          if (!defined) fail('custom element not defined (library failed to load)');
          if (window.lucide) { try { window.lucide.createIcons({ attrs: { 'stroke-width': 1.5 } }); } catch {} }
        }, 500);
      });
    </script>

    <script>
      // Share dialog bindings (global)
      function bindShare() {
        const modal = document.getElementById('shareModal');
        const closeBtn = document.getElementById('closeShareBtn');
        const shareNativeBtn = document.getElementById('shareNativeBtn');
        const shareCopyBtn = document.getElementById('shareCopyBtn');
        const learnStcLink = document.getElementById('learnStcLink');
        const shareContactBtn = document.getElementById('shareContactBtn');
        const urlSpan = document.getElementById('shareUrlText');

        closeBtn?.addEventListener('click', () => modal.classList.add('hidden'));
        shareNativeBtn?.addEventListener('click', async () => {
          const conf = getSchemeConfig(state.scheme || 'smart');
          const txt = buildShareText(conf);
          const url = urlSpan?.textContent || location.href;
          const shareData = { title: 'Solar Proposal', text: txt, url };
          try {
            if (navigator.share) {
              await navigator.share(shareData);
              showToast('System share opened', 'info');
              track('share_native', { scheme: state.scheme || 'smart' });
            } else {
              await navigator.clipboard.writeText(`${txt}\n${url}`);
              showToast('Copied link', 'success');
              track('share_copy_fallback', { scheme: state.scheme || 'smart' });
            }
          } catch {
            showToast('Share canceled', 'info');
          }
        });
        shareCopyBtn?.addEventListener('click', async () => {
          const url = urlSpan?.textContent || location.href;
          try { await navigator.clipboard.writeText(url); showToast('Link copied'); }
          catch { showToast('Copy failed', 'error'); }
        });
        learnStcLink?.addEventListener('click', (e) => {
          e.preventDefault();
          showToast('STC basics: Small-scale Technology Certificates reduce upfront cost based on zone and system size.', 'info', 2200);
        });
        shareContactBtn?.addEventListener('click', () => {
          modal.classList.add('hidden');
          const conf = getSchemeConfig(state.scheme || 'smart');
          state.subsidy = conf.subsidy;
          openLeadModal(conf.subsidy);
        });
      }
      function openShareModal() {
        const modal = document.getElementById('shareModal');
        const urlSpan = document.getElementById('shareUrlText');
        // Always override with the live page URL to avoid placeholder leaking
        if (urlSpan) urlSpan.textContent = location.href;
        modal.classList.remove('hidden');
        refreshIcons();
      }

      // Postcode helper (global)
      function extractPostcodeFromText(text) {
        if (!text) return '';
        const m = String(text).match(/\b(\d{4})\b/);
        return m ? m[1] : '';
      }
      function validateLeadTwoOfThree(name, email, phone) {
        const nameOk = !!(name && name.length >= 1 && name.length <= 40 && /^[^~`!@#$%^*+=<>?{}\[\]|\\]+$/.test(name));
        const emailOk = !!(email && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email));
        const phoneOk = !!(phone && /^(\+?61\s?)?[0-9\-\s]{6,}$/.test(phone));
        const score = (nameOk?1:0) + (emailOk?1:0) + (phoneOk?1:0);
        return score >= 2;
      }

      // Ensure lucide icons refresh utility is globally available
      function refreshIcons() {
        if (window.lucide) {
          try { window.lucide.createIcons({ attrs: { 'stroke-width': 1.5 } }); } catch {}
        }
      }

      // Chat helpers (kept structure)
      const chat = document.getElementById('chat');
      function addBotMsg(text) {
        const node = document.createElement('div');
        node.className = 'flex items-start gap-2.5';
        node.innerHTML = `
          <div class="shrink-0 h-8 w-8 rounded-full overflow-hidden ring-1 ring-white/10">
            <img src="Pic/bot.jpeg" alt="bot" class="h-full w-full object-cover" />
          </div>
          <div class="flex-1">
            <div class="inline-flex items-center gap-1.5 text-[11px] text-gray-700 mb-1">
              <i data-lucide="bot" class="w-3.5 h-3.5"></i>
              <span>AI Agent</span>
            </div>
            <div class="rounded-2xl px-3.5 py-2.5 bg-gray-100 border border-gray-200 shadow-sm">
              <p class="text-[14px] leading-5">${text}</p>
            </div>
          </div>
        `;
        chat.appendChild(node);
        refreshIcons();
        node.scrollIntoView({ behavior: 'smooth', block: 'end' });
      }
      function addUserMsg(text) {
        const node = document.createElement('div');
        node.className = 'flex items-start gap-2.5 justify-end';
        node.innerHTML = `
          <div class="flex-1"></div>
          <div class="text-right">
            <div class="inline-flex items-center gap-1.5 text-[11px] text-white/50 mb-1 justify-end">
              <span>You</span>
              <i data-lucide="user" class="w-3.5 h-3.5"></i>
            </div>
            <div class="inline-block rounded-2xl px-3.5 py-2.5 bg-white text-black border border-white/10 shadow">
              <p class="text-[14px] leading-5">${text}</p>
            </div>
          </div>
        `;
        chat.appendChild(node);
        refreshIcons();
        node.scrollIntoView({ behavior: 'smooth', block: 'end' });
      }

      // Toast
      function showToast(message, type = 'success', duration = 1400) {
        // Higher contrast toast for light sections
        const styles = {
          success: 'bg-emerald-600 text-white border-emerald-700',
          info: 'bg-gray-900 text-white border-gray-800',
          error: 'bg-red-600 text-white border-red-700'
        };
        const klass = styles[type] || styles.success;
        const toast = document.createElement('div');
        toast.className = `fixed bottom-16 left-1/2 -translate-x-1/2 z-[70] px-3 py-2 rounded-lg border shadow-lg ${klass}`;
        toast.innerHTML = `<div class="flex items-center gap-1.5">
          <i data-lucide="check" class="w-3.5 h-3.5"></i>
          <span>${message}</span>
        </div>`;
        document.body.appendChild(toast);
        refreshIcons();
        setTimeout(() => {
          toast.style.transition = 'opacity .25s ease';
          toast.style.opacity = '0';
          setTimeout(() => toast.remove(), duration + 320);
        }, duration);
      }

      // Export helpers
      async function saveBudgetAsImage() {
        const target = document.getElementById('s4BudgetPanel');
        if (!target) { showToast('Budget panel not found', 'error'); return; }
        // Ensure library
        if (!(window.html2canvas)) { showToast('Image export not ready', 'error'); return; }
        try {
          const canvas = await window.html2canvas(target, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
          const dataUrl = canvas.toDataURL('image/png');
          const a = document.createElement('a');
          const scheme = (window.state && window.state.scheme) || 'smart';
          const ts = new Date().toISOString().replace(/[:.]/g, '-');
          a.href = dataUrl;
          a.download = `solar_budget_${scheme}_${ts}.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          showToast('Image saved');
          try { track('s4_save_image', { scheme }); } catch {}
        } catch (e) {
          console.error('saveBudgetAsImage failed', e);
          showToast('Save failed', 'error');
        }
      }

      // Cards/steps
      const cards = document.getElementById('cards');
      const stepEls = Array.from(cards.querySelectorAll('[data-step]'));
      function showStep(n) {
        stepEls.forEach((el) => {
          const idx = el.getAttribute('data-step');
          if (idx === String(n)) {
            el.classList.remove('hidden');
            el.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'end' }), 50);
          } else {
            el.classList.add('hidden');
          }
        });
        // Toggle 6A visibility with Step 6
        const card6A = document.getElementById('card6A');
        if (card6A) card6A.classList.toggle('hidden', String(n) !== '6');
        if (String(n) === '6') {
          // exposure track once per session
          if (!state._s6a_exposed) { track('s6a_expose', { scheme: state.scheme || 'smart' }); state._s6a_exposed = true; }
        }
        refreshIcons();
      }

      // Global state
      const state = {
        address: '',
        roofSelected: false,
        roofPoint: null,
        scheme: null, // smart | efficient | independence | ultimate
        saving: 0,
        subsidy: 0,
        rotationY: 0
      };

      // Pricing / range config for Step 6A
      const pricingConfig = {
        kwMin: 1400, // $/kW lower bound
        kwMax: 1900, // $/kW upper bound
        batteryAdderMin: 3500,
        batteryAdderMax: 6500,
        savingVarPct: 0.12, // ±12%
        selfUseVarPct: 0.05 // ±5%
      };

      // Simple analytics stub
      function track(event, payload = {}) {
        console.log('[track]', event, payload);
      }

      function boot() {
        // Initial chatbot line
        addBotMsg('Hi! I\'m your AI solar advisor. Enter your address to get started.');
        showStep(1);
        bindStep1();
        bindStep2();
        bindStep3();
        bindStep4();
        bindStep5();
        bindStep6();
        bindStep6A();
        bindLead();
        bindShare();
        bindBottomChat();

        // Pre-populate Step 4 budget panel with default plan so values are never empty
        try {
          const conf = getSchemeConfig('smart');
          updateS4BudgetPanel(conf);
        } catch {}
      }

      // Step 1
      function bindStep1() {
        const addressInput = document.getElementById('addressInput');
        const startBtn = document.getElementById('startExploreBtn');
        const useLocationBtn = document.getElementById('useLocationBtn');
        const addrError = document.getElementById('addrError');
        addressInput?.addEventListener('input', () => {
          const ok = (addressInput.value || '').trim().length >= 6;
          startBtn.disabled = !ok;
          addrError.classList.toggle('hidden', ok || (addressInput.value || '').length === 0);
        });
        startBtn?.addEventListener('click', () => {
          const addr = (addressInput.value || '').trim();
          if (addr.length < 6) {
            addrError.classList.remove('hidden');
            return;
          }
          state.address = addr;
          addUserMsg(`Address: ${addr}`);
          addBotMsg('Got it. Please tap your roof on the map to confirm.');
          // Pass label to step2
          const addrLabel = document.getElementById('addrLabel');
          if (addrLabel) addrLabel.textContent = addr;
          showStep(2);
          // mimic geolocate zoom center
          centerMap();
        });
        useLocationBtn?.addEventListener('click', () => {
          showToast('Locating...');
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (pos) => {
                showToast('Location found');
                // In demo, just hint to fill address
                if (!addressInput.value) {
                  addressInput.value = `Lat/Lng ${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`;
                  startBtn.disabled = false;
                }
              },
              () => showToast('Location failed, please enter address manually')
            );
          } else {
            showToast('Geolocation not supported, please enter address manually');
          }
        });
      }

      // Step 2 - enhanced image map with selection, undo, reset
      function bindStep2() {
        const backTo1 = document.getElementById('backTo1');
        const mapViewport = document.getElementById('mapViewport');
        const mapImage = document.getElementById('mapImage');
        const roofOverlay = document.getElementById('roofOverlay');
        const confirmRoofBtn = document.getElementById('confirmRoofBtn');
        const roofHint = document.getElementById('roofHint');
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');
        const rectSelectBtn = document.getElementById('rectSelect');
        const resetViewBtn = document.getElementById('resetView');
        const undoActionBtn = document.getElementById('undoAction');

        if (!mapViewport || !mapImage || !roofOverlay) return;

        // Interaction state
        const state2 = {
          scale: 1.6,
          tx: 0,
          ty: 0,
          isSelecting: false,
          isDragging: false,
          startPos: null,
          lastPos: null,
          history: [],
          roofSelected: false,
          roofPoint: null,
          selectionRect: null
        };

        function applyTransform() {
          mapImage.style.transform = `translate(${state2.tx}px, ${state2.ty}px) translate(-50%, -50%) scale(${state2.scale})`;
        }
        function pxToPct(pxX, pxY){
          const rect = mapViewport.getBoundingClientRect();
          return { x: (pxX / rect.width) * 100, y: (pxY / rect.height) * 100 };
        }
        function pushHistory() {
          state2.history.push({
            scale: state2.scale,
            tx: state2.tx,
            ty: state2.ty,
            overlayHTML: roofOverlay.innerHTML,
            roofSelected: state2.roofSelected,
            roofPoint: state2.roofPoint
          });
          if (state2.history.length > 50) state2.history.shift();
        }
        function undo() {
          const last = state2.history.pop();
          if (!last) return;
          state2.scale = last.scale;
          state2.tx = last.tx;
          state2.ty = last.ty;
          state2.roofSelected = last.roofSelected;
          state2.roofPoint = last.roofPoint;
          roofOverlay.innerHTML = last.overlayHTML;
          updateRoofHint();
          confirmRoofBtn.disabled = !state2.roofSelected;
          applyTransform();
        }
        function resetView() {
          pushHistory();
          state2.scale = 1.6;
          state2.tx = 0; state2.ty = 0;
          state2.isSelecting = false;
          state2.roofSelected = false;
          state2.roofPoint = null;
          rectSelectBtn?.classList.remove('bg-emerald-500','border-emerald-500','text-white');
          rectSelectBtn?.classList.add('bg-white/90','border-gray-200');
          roofOverlay.innerHTML = '';
          updateRoofHint();
          confirmRoofBtn.disabled = true;
          applyTransform();
        }
        function zoomAt(factor, cx, cy) {
          pushHistory();
          const newScale = Math.min(4, Math.max(0.6, state2.scale * factor));
          if ((newScale >= 4 && factor > 1) || (newScale <= 0.6 && factor < 1)) return;
          const rect = mapViewport.getBoundingClientRect();
          const vx = cx - rect.width / 2;
          const vy = cy - rect.height / 2;
          const mapX = (vx - state2.tx) / state2.scale;
          const mapY = (vy - state2.ty) / state2.scale;
          state2.scale = newScale;
          state2.tx = vx - mapX * state2.scale;
          state2.ty = vy - mapY * state2.scale;
          applyTransform();
        }
        function updateRoofHint() {
          if (!roofHint) return;
          if (state2.roofSelected) {
            roofHint.textContent = 'Roof position selected';
            roofHint.classList.remove('text-gray-600');
            roofHint.classList.add('text-emerald-600','font-medium');
          } else {
            roofHint.textContent = 'Tap your roof on the map';
            roofHint.classList.remove('text-emerald-600','font-medium');
            roofHint.classList.add('text-gray-600');
          }
        }
        function drawRoofAt(clientX, clientY) {
          const rect = mapViewport.getBoundingClientRect();
          const x = ((clientX - rect.left) / rect.width) * 100;
          const y = ((clientY - rect.top) / rect.height) * 100;
          const w = 20, h = 15;
          roofOverlay.innerHTML = `
            <rect x="${x - w/2}" y="${y - h/2}" width="${w}" height="${h}" rx="2" ry="2"
                  fill="rgba(16,185,129,0.30)" stroke="rgba(110,231,183,0.9)" stroke-width="1.2" class="roof-pulse"/>
          `;
          state2.roofSelected = true;
          state2.roofPoint = { x, y };
          updateRoofHint();
          if (confirmRoofBtn) confirmRoofBtn.disabled = false;
        }
        function onPointerDown(evt){
          evt.preventDefault();
          const rect = mapViewport.getBoundingClientRect();
          const x = evt.clientX - rect.left;
          const y = evt.clientY - rect.top;
          state2.isDragging = true;
          state2.startPos = { x, y };
          state2.lastPos = { x, y };
          if (state2.isSelecting) {
            pushHistory();
            state2.selectionRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
            const p = pxToPct(x, y);
            state2.selectionRect.setAttribute('x', p.x);
            state2.selectionRect.setAttribute('y', p.y);
            state2.selectionRect.setAttribute('width','0');
            state2.selectionRect.setAttribute('height','0');
            state2.selectionRect.setAttribute('stroke','#3B82F6');
            state2.selectionRect.setAttribute('stroke-width','1.5');
            state2.selectionRect.setAttribute('fill','rgba(59, 130, 246, 0.15)');
            state2.selectionRect.setAttribute('pointer-events','none');
            roofOverlay.appendChild(state2.selectionRect);
          }
          mapViewport.style.cursor = 'grabbing';
          mapViewport.setPointerCapture?.(evt.pointerId);
        }
        function onPointerMove(evt){
          if (!state2.isDragging) return;
          const rect = mapViewport.getBoundingClientRect();
          const x = evt.clientX - rect.left;
          const y = evt.clientY - rect.top;
          if (state2.isSelecting && state2.selectionRect) {
            const p0 = pxToPct(state2.startPos.x, state2.startPos.y);
            const p1 = pxToPct(x, y);
            const rx = Math.min(p0.x, p1.x);
            const ry = Math.min(p0.y, p1.y);
            const rw = Math.abs(p1.x - p0.x);
            const rh = Math.abs(p1.y - p0.y);
            state2.selectionRect.setAttribute('x', rx);
            state2.selectionRect.setAttribute('y', ry);
            state2.selectionRect.setAttribute('width', rw);
            state2.selectionRect.setAttribute('height', rh);
          } else {
            const dx = x - state2.lastPos.x;
            const dy = y - state2.lastPos.y;
            state2.tx += dx; state2.ty += dy;
            applyTransform();
          }
          state2.lastPos = { x, y };
        }
        function onPointerUp(evt){
          if (!state2.isDragging) return;
          const rect = mapViewport.getBoundingClientRect();
          const x = evt.clientX - rect.left;
          const y = evt.clientY - rect.top;
          const dx = x - state2.startPos.x;
          const dy = y - state2.startPos.y;
          const isClick = (dx*dx + dy*dy) < 25;
          if (isClick && !state2.isSelecting) {
            pushHistory();
            drawRoofAt(evt.clientX, evt.clientY);
            const pct = pxToPct(x, y);
            const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
            dot.setAttribute('cx', pct.x);
            dot.setAttribute('cy', pct.y);
            dot.setAttribute('r', 1.2);
            dot.setAttribute('fill', '#10B981');
            dot.setAttribute('stroke', '#A7F3D0');
            dot.setAttribute('stroke-width', '0.6');
            roofOverlay.appendChild(dot);
          }
          if (state2.isSelecting) {
            if (state2.selectionRect) {
              const width = parseFloat(state2.selectionRect.getAttribute('width') || '0');
              const height = parseFloat(state2.selectionRect.getAttribute('height') || '0');
              if (width < 2 || height < 2) {
                if (roofOverlay.contains(state2.selectionRect)) roofOverlay.removeChild(state2.selectionRect);
              } else {
                const rx = parseFloat(state2.selectionRect.getAttribute('x') || '0');
                const ry = parseFloat(state2.selectionRect.getAttribute('y') || '0');
                roofOverlay.innerHTML = `
                  <rect x="${rx}" y="${ry}" width="${width}" height="${height}" rx="2" ry="2"
                        fill="rgba(16,185,129,0.30)" stroke="rgba(110,231,183,0.9)" stroke-width="1.2" class="roof-pulse"/>
                `;
                state2.roofSelected = true;
                state2.roofPoint = { x: rx + width/2, y: ry + height/2 };
                updateRoofHint();
                if (confirmRoofBtn) confirmRoofBtn.disabled = false;
                pushHistory();
                state2.isSelecting = false;
                rectSelectBtn?.classList.remove('bg-emerald-500','border-emerald-500','text-white');
                rectSelectBtn?.classList.add('bg-white/90','border-gray-200');
              }
              state2.selectionRect = null;
            }
          }
          state2.isDragging = false;
          state2.startPos = null;
          state2.lastPos = null;
        }

        // Bindings
        mapViewport?.addEventListener('pointerdown', onPointerDown);
        mapViewport?.addEventListener('pointermove', onPointerMove);
        mapViewport?.addEventListener('pointerup', onPointerUp);
        mapViewport?.addEventListener('wheel', (e) => {
          e.preventDefault();
          const factor = e.deltaY < 0 ? 1.1 : 0.9;
          zoomAt(factor, e.clientX, e.clientY);
        }, { passive: false });
        zoomInBtn?.addEventListener('click', (e) => {
          const rect = mapViewport.getBoundingClientRect();
          zoomAt(1.15, rect.left + rect.width/2, rect.top + rect.height/2);
        });
        zoomOutBtn?.addEventListener('click', (e) => {
          const rect = mapViewport.getBoundingClientRect();
          zoomAt(0.85, rect.left + rect.width/2, rect.top + rect.height/2);
        });
        rectSelectBtn?.addEventListener('click', () => {
          state2.isSelecting = !state2.isSelecting;
          if (state2.isSelecting) {
            rectSelectBtn.classList.add('bg-emerald-500','border-emerald-500','text-white');
            rectSelectBtn.classList.remove('bg-white/90','border-gray-200');
          } else {
            rectSelectBtn.classList.remove('bg-emerald-500','border-emerald-500','text-white');
            rectSelectBtn.classList.add('bg-white/90','border-gray-200');
          }
        });
        resetViewBtn?.addEventListener('click', resetView);
        undoActionBtn?.addEventListener('click', undo);

        backTo1?.addEventListener('click', () => {
          addUserMsg('Back to edit address');
          showStep(1);
        });
        confirmRoofBtn?.addEventListener('click', () => {
          addUserMsg('Roof confirmed on the map');
          addBotMsg('Great. Running analysis... It\'s like magic!');
          roofOverlay.innerHTML = '';
          state2.roofSelected = false;
          showStep(3);
          runAnalysis();
        });

        // expose centerMap for Step1
        function centerMap() { state2.scale = 1.6; state2.tx = 0; state2.ty = 0; applyTransform(); }
        window.centerMap = centerMap;

        // initial
        applyTransform();
      }
      function centerMap() { /* replaced by bindStep2 */ }

      // Step 3 - analysis sequence
      function bindStep3() {
        // nothing to bind; we'll handle in runAnalysis()
      }
      function runAnalysis() {
        const t1 = document.getElementById('task1');
        const t2 = document.getElementById('task2');
        const t3 = document.getElementById('task3');
        const done = (el) => {
          el.classList.remove('text-white/70');
          el.classList.add('text-emerald-300');
          el.querySelector('i')?.setAttribute('data-lucide', 'check');
          refreshIcons();
        };
        setTimeout(() => done(t1), 600);
        setTimeout(() => done(t2), 1200);
        setTimeout(() => done(t3), 1800);
        setTimeout(() => {
          addBotMsg('Analysis complete! Good news — your roof is a great fit. Here is your 3D model.');
          showStep(4);
        }, 2200);
      }

      // Step 4 - 3D mock rotation
      function bindStep4() {
        const backTo2 = document.getElementById('backTo2');
        const modelViewer = document.querySelector('#viewer3d model-viewer');
        const strip = document.getElementById('schemesStrip4');
        const leadBtn = document.getElementById('s4_openLeadBtn');
        const s4CopyBtn = document.getElementById('s4CopyBtn');
        const s4ShareBtn = document.getElementById('s4ShareBtn');
        const s4SaveImgBtn = document.getElementById('s4SaveImgBtn');
        const s4RefineBtn = document.getElementById('s4RefineBtn');

        // Back to previous step
        backTo2?.addEventListener('click', () => {
          addUserMsg('Back to roof confirmation');
          showStep(2);
        });

        // Plan selection (in-card linkage)
        if (strip) {
          const buttons = Array.from(strip.querySelectorAll('.scheme-card-mini'));
          const selectScheme = (key) => {
            const conf = getSchemeConfig(key);
            state.scheme = key;
            // 3D 轻量过渡（淡入/缩放）
            if (modelViewer) {
              modelViewer.style.opacity = '0.6';
              modelViewer.style.transform = 'scale(0.985)';
            }
            // 更新 KPI & 预算面板
            applyValuePresentation(conf);
            try { updateS4BudgetPanel(conf); } catch {}
            // 选中态高亮
            buttons.forEach(btn => btn.classList.toggle('ring-2', btn.dataset.scheme === key));
            buttons.forEach(btn => btn.classList.toggle('ring-emerald-300', btn.dataset.scheme === key));
            // 恢复 3D 过渡
            if (modelViewer) {
              setTimeout(() => {
                modelViewer.style.opacity = '1';
                modelViewer.style.transform = 'scale(1)';
              }, 180);
            }
          };
          // click 绑定 + 容器委托兜底
          buttons.forEach(btn => btn.addEventListener('click', () => selectScheme(btn.dataset.scheme)));
          strip.addEventListener('click', (e) => {
            const btn = e.target.closest('.scheme-card-mini');
            if (!btn || !strip.contains(btn)) return;
            const key = btn.getAttribute('data-scheme');
            if (!key) return;
            selectScheme(key);
          });
          // 默认方案
          selectScheme('smart');
        }

        // Open subsidy quote (reuse existing modal)
        leadBtn?.addEventListener('click', () => {
          const conf = getSchemeConfig(state.scheme || 'smart');
          state.subsidy = conf.subsidy;
          openLeadModal(conf.subsidy);
          addBotMsg(`Looks compelling, right? You may also qualify for about $${(conf.subsidy || 3000).toLocaleString()} in government subsidies. Want the final price including subsidies? Leave your details and I'll send the full report.`);
        });

        // Step 4 action buttons wiring
        s4CopyBtn?.addEventListener('click', async () => {
          const conf = getSchemeConfig(state.scheme || 'smart');
          const txt = buildShareText(conf);
          const url = location.href;
          try { await navigator.clipboard.writeText(`${txt}\nLink: ${url}`); showToast('Quote copied'); }
          catch { showToast('Copy failed', 'error'); }
        });
        const openShare = () => { openShareModal(); track('s4_share_open', { scheme: state.scheme || 'smart' }); };
        s4ShareBtn?.addEventListener('click', openShare);
        // Save image: export budget panel as PNG
        s4SaveImgBtn?.addEventListener('click', saveBudgetAsImage);
        s4RefineBtn?.addEventListener('click', () => {
          const conf = getSchemeConfig(state.scheme || 'smart');
          state.subsidy = conf.subsidy;
          openLeadModal(conf.subsidy);
        });
      }

      // Panel rendering utility
      function renderPanels(container, count) {
        container.innerHTML = '';
        const cols = 6;
        const gap = 6; // px
        const w = (260 - (cols - 1) * gap) / cols; // match roof width
        let placed = 0;
        for (let r = 0; r < 5 && placed < count; r++) {
          for (let c = 0; c < cols && placed < count; c++) {
            const x = c * (w + gap) + 8;
            const y = r * (w * 0.55 + gap) + 8;
            const panel = document.createElement('div');
            panel.className = 'absolute bg-sky-300/20 border border-sky-200/30 rounded-[6px] shadow-sm';
            panel.style.left = `${x}px`;
            panel.style.top = `${y}px`;
            panel.style.width = `${w}px`;
            panel.style.height = `${w * 0.55}px`;
            container.appendChild(panel);
            placed++;
          }
        }
      }

      // Step 5 - schemes
      function bindStep5() {
        const backTo4 = document.getElementById('backTo4');
        const house3d5 = document.getElementById('house3dStep5');
        const pvPanels5 = document.getElementById('pvPanels5');
        const batteryWall5 = document.getElementById('batteryWall5');
        const schemeCards = Array.from(document.querySelectorAll('.scheme-card'));

        // sync rotation
        house3d5.style.transform = `rotateX(55deg) rotateY(${state.rotationY}deg) scale(1)`;
        renderPanels(pvPanels5, 12);
        batteryWall5.classList.add('hidden');

        // rotate drag
        let dragging = false, lastX = 0;
        house3d5?.parentElement?.addEventListener('mousedown', (e) => { dragging = true; lastX = e.clientX; });
        window.addEventListener('mouseup', () => dragging = false);
        window.addEventListener('mousemove', (e) => {
          if (!dragging) return;
          const dx = e.clientX - lastX;
          lastX = e.clientX;
          state.rotationY += dx * 0.3;
          house3d5.style.transform = `rotateX(55deg) rotateY(${state.rotationY}deg) scale(1)`;
        });
        house3d5?.parentElement?.addEventListener('touchstart', (e) => { if (e.touches[0]) { dragging = true; lastX = e.touches[0].clientX; } }, { passive: true });
        window.addEventListener('touchend', () => dragging = false);
        window.addEventListener('touchmove', (e) => {
          if (!dragging || !e.touches[0]) return;
          const dx = e.touches[0].clientX - lastX;
          lastX = e.touches[0].clientX;
          state.rotationY += dx * 0.3;
          house3d5.style.transform = `rotateX(55deg) rotateY(${state.rotationY}deg) scale(1)`;
        }, { passive: true });

        backTo4?.addEventListener('click', () => {
          addUserMsg('Back to 3D model');
          showStep(4);
        });

        schemeCards.forEach((btn) => {
          btn.addEventListener('click', () => {
            const key = btn.getAttribute('data-scheme');
            const conf = getSchemeConfig(key);
            state.scheme = key;
            renderPanels(pvPanels5, conf.panels);
            batteryWall5.classList.toggle('hidden', !conf.battery);
            // small pulse
            pvPanels5.classList.add('animate-pulse');
            setTimeout(() => pvPanels5.classList.remove('animate-pulse'), 400);
            // to Step 6
            setTimeout(() => {
              if (key === 'independence') {
                addBotMsg('With "Energy Independence", your bill drops to zero — and you can even earn!');
              }
              applyValuePresentation(conf);
              showStep(6);
            }, 300);
          });
        });
      }

      function getSchemeConfig(key) {
        // mock numbers
        const base = {
          smart: { name: 'Smart Saver', panels: 10, battery: false, sizeKW: 4.0, selfUse: 0.55, saving: 4200, roi: '4–5 years', subsidy: 2200 },
          efficient: { name: 'High Efficiency', panels: 16, battery: false, sizeKW: 6.5, selfUse: 0.6, saving: 6200, roi: '4 years', subsidy: 2800 },
          independence: { name: 'Energy Independence', panels: 20, battery: true, sizeKW: 8.0, selfUse: 0.78, saving: 9600, roi: '5–6 years', subsidy: 3600 },
          ultimate: { name: 'Ultimate Energy', panels: 26, battery: true, sizeKW: 10.0, selfUse: 0.82, saving: 11800, roi: '5 years', subsidy: 4200 }
        };
        return base[key] || base.smart;
      }

      // Step 6 - value presentation
      function bindStep6() {
        const backTo5 = document.getElementById('backTo5');
        const openLeadBtn = document.getElementById('openLeadBtn');
        backTo5?.addEventListener('click', () => {
          addUserMsg('View other plans');
          showStep(5);
        });
        openLeadBtn?.addEventListener('click', () => {
          const conf = getSchemeConfig(state.scheme || 'smart');
          state.subsidy = conf.subsidy;
          openLeadModal(conf.subsidy);
          addBotMsg(`Looks compelling, right? You may also qualify for about $${(conf.subsidy || 3000).toLocaleString()} in government subsidies. Want the final price including subsidies? Leave your details and I'll send the full report.`);
        });
      }

      // Step 6A - actions & range presentation
      function bindStep6A() {
        const copyBtn = document.getElementById('copyQuoteBtn');
        const shareBtn = document.getElementById('shareQuoteBtn');
        const refineBtn = document.getElementById('refineInfoBtn');

        copyBtn?.addEventListener('click', async () => {
          const conf = getSchemeConfig(state.scheme || 'smart');
          const txt = buildShareText(conf);
          try {
            await navigator.clipboard.writeText(txt);
            showToast('Quote copied');
            track('s6a_copy', { scheme: state.scheme || 'smart' });
          } catch (e) {
            console.warn('Copy failed', e);
            showToast('Copy failed');
          }
        });

        shareBtn?.addEventListener('click', () => {
          openShareModal();
          track('s6a_share_dialog', { scheme: state.scheme || 'smart' });
        });

        refineBtn?.addEventListener('click', () => {
          const conf = getSchemeConfig(state.scheme || 'smart');
          state.subsidy = conf.subsidy;
          openLeadModal(conf.subsidy);
          track('s6a_refine', { scheme: state.scheme || 'smart' });
        });
      }

      function computeRangesFromConf(conf) {
        // Budget range based on kW and optional battery
        const baseLow = conf.sizeKW * pricingConfig.kwMin;
        const baseHigh = conf.sizeKW * pricingConfig.kwMax;
        const battLow = conf.battery ? pricingConfig.batteryAdderMin : 0;
        const battHigh = conf.battery ? pricingConfig.batteryAdderMax : 0;
        const budget = { low: Math.round(baseLow + battLow), high: Math.round(baseHigh + battHigh) };

        // Savings range around conf.saving
        const sv = pricingConfig.savingVarPct;
        const saving = { low: Math.round(conf.saving * (1 - sv)), high: Math.round(conf.saving * (1 + sv)) };

        // Self-use range
        const su = pricingConfig.selfUseVarPct;
        const selfUse = { low: Math.max(0, conf.selfUse - su), high: Math.min(0.98, conf.selfUse + su) };

        // Payback rough = budget / saving (years)
        const roiLow = Math.max(1.5, budget.low / Math.max(1, saving.high));
        const roiHigh = Math.max(roiLow + 0.2, budget.high / Math.max(1, saving.low));
        const roi = { low: roiLow, high: roiHigh };

        return { budget, saving, selfUse, roi };
      }

      function formatCurrency(n) { return `$${n.toLocaleString()}`; }
      function formatPct(p) { return `${Math.round(p * 100)}%`; }
      function formatYears(a, b) { return `${a.toFixed(1)}–${b.toFixed(1)} years`; }

      function update6ACard(conf) {
        const els = {
          budget: document.getElementById('s6a_budget'),
          roi: document.getElementById('s6a_roi'),
          self: document.getElementById('s6a_selfuse'),
          saving: document.getElementById('s6a_saving')
        };
        const r = computeRangesFromConf(conf);
        if (els.budget) els.budget.textContent = `${formatCurrency(r.budget.low)} – ${formatCurrency(r.budget.high)}`;
        if (els.roi) els.roi.textContent = formatYears(r.roi.low, r.roi.high);
        if (els.self) els.self.textContent = `${formatPct(r.selfUse.low)} – ${formatPct(r.selfUse.high)}`;
        if (els.saving) els.saving.textContent = `${formatCurrency(r.saving.low)} – ${formatCurrency(r.saving.high)}`;
      }

      function buildShareText(conf) {
        const r = computeRangesFromConf(conf);
        const lines = [
          `Plan: ${conf.name}`,
          `System size: ${conf.sizeKW.toFixed(1)} kW${conf.battery ? ' + battery' : ''}`,
          `Budget (incl. tax): ${formatCurrency(r.budget.low)} – ${formatCurrency(r.budget.high)}`,
          `Payback: ${formatYears(r.roi.low, r.roi.high)}`,
          `Self-consumption: ${formatPct(r.selfUse.low)} – ${formatPct(r.selfUse.high)}`,
          `Annual savings: ${formatCurrency(r.saving.low)} – ${formatCurrency(r.saving.high)}`,
          `Note: Preliminary estimate (incl. tax), excluding grid connection & subsidy differences.`,
          `Link: ${location.href}`
        ];
        return lines.join('\n');
      }

      function applyValuePresentation(conf) {
        // Step 6 original elements
        const savingNumber = document.getElementById('savingNumber');
        const schemeTag = document.getElementById('schemeTag');
        const sizeText = document.getElementById('sizeText');
        const roiText = document.getElementById('roiText');
        const selfUseText = document.getElementById('selfUseText');
        // compute ranges for unified display (Step 6)
        const r = computeRangesFromConf(conf);
        if (schemeTag) schemeTag.innerHTML = `<span>${conf.name}</span>`;
        if (sizeText) sizeText.textContent = `${conf.sizeKW.toFixed(1)} kW (≈ ${conf.panels} panels${conf.battery ? ' + battery' : ''})`;
        if (roiText) roiText.textContent = formatYears(r.roi.low, r.roi.high);
        if (selfUseText) selfUseText.textContent = `${Math.round(r.selfUse.low * 100)}% – ${Math.round(r.selfUse.high * 100)}%`;
        if (savingNumber) savingNumber.textContent = `${formatCurrency(r.budget.low)} – ${formatCurrency(r.budget.high)}`;

        // Step 4 elements (s4_ prefix)
        const s4_savingNumber = document.getElementById('s4_savingNumber');
        const s4_schemeTag = document.getElementById('s4_schemeTag');
        const s4_sizeText = document.getElementById('s4_sizeText');
        const s4_roiText = document.getElementById('s4_roiText');
        const s4_selfUseText = document.getElementById('s4_selfUseText');
        if (s4_schemeTag) s4_schemeTag.innerHTML = `<span>${conf.name}</span>`;
        if (s4_sizeText) s4_sizeText.textContent = `${conf.sizeKW.toFixed(1)} kW / ${conf.panels} panels${conf.battery ? ' + battery' : ''}`;
        if (s4_roiText) s4_roiText.textContent = conf.roi;
        if (s4_selfUseText) s4_selfUseText.textContent = `${Math.round(r.selfUse.low * 100)}% – ${Math.round(r.selfUse.high * 100)}%`;
        if (s4_savingNumber) s4_savingNumber.textContent = `$${conf.saving.toLocaleString()}`;

        state.saving = conf.saving;

        // Update Step 6A card content as well
        update6ACard(conf);
      }

      // Step 4 budget panel updater
      function updateS4BudgetPanel(conf) {
        console.debug('[Step4] updateS4BudgetPanel', { scheme: state.scheme, conf });
        const r = computeRangesFromConf(conf);
        const elBudget = document.getElementById('s4BudgetRange');
        const elSize   = document.getElementById('s4SizeRange');
        const elRoi    = document.getElementById('s4PaybackRange');
        const elSelf   = document.getElementById('s4SelfUseRange');
        const elSave   = document.getElementById('s4AnnualSaveRange');
        if (elBudget) elBudget.textContent = `${formatCurrency(r.budget.low)} – ${formatCurrency(r.budget.high)}`;
        if (elSize)   elSize.textContent   = `${conf.sizeKW.toFixed(1)} kW${conf.battery ? ' + battery' : ''} (≈ ${conf.panels} panels)`;
        if (elRoi)    elRoi.textContent    = formatYears(r.roi.low, r.roi.high);
        if (elSelf)   elSelf.textContent   = `${Math.round(r.selfUse.low * 100)}% – ${Math.round(r.selfUse.high * 100)}%`;
        if (elSave)   elSave.textContent   = `${formatCurrency(r.saving.low)} – ${formatCurrency(r.saving.high)}`;

        // Brief highlight to indicate numbers updated
        const panel = document.getElementById('s4BudgetPanel');
        if (panel) {
          panel.classList.add('ring-2','ring-emerald-300');
          setTimeout(() => panel.classList.remove('ring-2','ring-emerald-300'), 420);
        }
        if (elBudget) {
          elBudget.classList.add('animate-pulse');
          setTimeout(() => elBudget.classList.remove('animate-pulse'), 420);
        }

        // Buttons
        const copyBtn = document.getElementById('s4CopyBtn');
        const shareBtn = document.getElementById('s4ShareBtn');
        const refineBtn = document.getElementById('s4RefineBtn');
        if (copyBtn) copyBtn.onclick = async () => {
          const txt = buildShareText(conf);
          try { await navigator.clipboard.writeText(txt); showToast('Quote copied', 'success'); }
          catch { showToast('Copy failed', 'error'); }
        };
        if (shareBtn) shareBtn.onclick = async () => {
          const txt = buildShareText(conf);
          const shareData = { title: 'Solar Quote', text: txt, url: location.href };
          try {
            if (navigator.share) { await navigator.share(shareData); showToast('System share opened', 'info'); }
            else { await navigator.clipboard.writeText(txt + '\n' + location.href); showToast('Copied share content', 'success'); }
          } catch { showToast('Share canceled', 'info'); }
        };
        if (refineBtn) refineBtn.onclick = () => {
          state.subsidy = conf.subsidy;
          openLeadModal(conf.subsidy);
        };
      }

      function animateNumber(el, target, prefix = '') {
        const duration = 900;
        const start = performance.now();
        function frame(now) {
          const t = Math.min(1, (now - start) / duration);
          const val = Math.floor(target * (0.15 + 0.85 * t * (2 - t))); // ease-out-ish
          el.textContent = `${prefix}${val.toLocaleString()}`;
          if (t < 1) requestAnimationFrame(frame);
        }
        requestAnimationFrame(frame);
      }

      // Global helper for debugging and guaranteed scheme switching from console
      window.selectScheme4 = (key) => {
        const conf = getSchemeConfig(key || 'smart');
        state.scheme = key || 'smart';
        const modelViewer = document.querySelector('#viewer3d model-viewer');
        // 3D 轻量过渡
        if (modelViewer) {
          modelViewer.style.opacity = '0.6';
          modelViewer.style.transform = 'scale(0.985)';
        }
        // 更新 KPI & 预算面板
        applyValuePresentation(conf);
        try { updateS4BudgetPanel(conf); } catch {}
        // 选中态高亮（若条带存在）
        const strip = document.getElementById('schemesStrip4');
        if (strip) {
          const buttons = Array.from(strip.querySelectorAll('.scheme-card-mini'));
          buttons.forEach(btn => btn.classList.toggle('ring-2', btn.dataset.scheme === state.scheme));
          buttons.forEach(btn => btn.classList.toggle('ring-emerald-300', btn.dataset.scheme === state.scheme));
        }
        // 恢复 3D 过渡
        if (modelViewer) {
          setTimeout(() => {
            modelViewer.style.opacity = '1';
            modelViewer.style.transform = 'scale(1)';
          }, 180);
        }
      };

      // Lead modal (Step 7 trigger)
      function bindLead() {
        const modal = document.getElementById('leadModal');
        const closeBtn = document.getElementById('closeLeadBtn');
        const submitBtn = document.getElementById('submitLeadBtn');
        const leadName = document.getElementById('leadName');
        const leadEmail = document.getElementById('leadEmail');
        const leadPhone = document.getElementById('leadPhone');
        const leadPostcode = document.getElementById('leadPostcode');
        const leadNotes = document.getElementById('leadNotes');
        const leadConsent = document.getElementById('leadConsent');
        const leadError = document.getElementById('leadError');

        closeBtn?.addEventListener('click', () => modal.classList.add('hidden'));

        submitBtn?.addEventListener('click', () => {
          const name = (leadName.value || '').trim();
          const email = (leadEmail.value || '').trim();
          const phone = (leadPhone.value || '').trim();
          const pc = (leadPostcode.value || '').trim();
          const consentOk = !!leadConsent?.checked;
          const twoOk = validateLeadTwoOfThree(name, email, phone);
          const pcOk = /^\d{4}$/.test(pc);
          const ok = twoOk && pcOk && consentOk;
          if (ok) {
            leadError.classList.add('hidden');
            modal.classList.add('hidden');
            addUserMsg(`Submitted: ${name || '(no name)'} / ${email || '(no email)'} / ${phone || '(no phone)'} / ${pc}`);
            addBotMsg('Thanks! We\'ll send the full report shortly, including the subsidy-adjusted price.');
            showStep(7);
            track('lead_submit', { hasName: !!name, hasEmail: !!email, hasPhone: !!phone });
          } else {
            leadError.classList.remove('hidden');
            showToast('Please complete required fields', 'error');
          }
        });
      }
      function openLeadModal(subsidy) {
        const modal = document.getElementById('leadModal');
        const hint = document.getElementById('subsidyHint');
        hint.textContent = `Based on your plan, you may qualify for about $${(subsidy || 3000).toLocaleString()} in government subsidies. Enter your details to view the final price including subsidies.`;
        // Prefill postcode from address if available
        const leadPostcode = document.getElementById('leadPostcode');
        if (leadPostcode && !leadPostcode.value) {
          const pc = extractPostcodeFromText(state.address || '');
          if (pc) leadPostcode.value = pc;
        }
        modal.classList.remove('hidden');
        refreshIcons();
      }

      // Restart
      document.getElementById('restartBtn')?.addEventListener('click', () => {
        // reset state
        state.address = '';
        state.roofSelected = false;
        state.roofPoint = null;
        state.scheme = null;
        state.saving = 0;
        state.subsidy = 0;
        state.rotationY = 0;
        // reset inputs
        const addressInput = document.getElementById('addressInput');
        addressInput && (addressInput.value = '');
        document.getElementById('startExploreBtn')?.setAttribute('disabled', 'true');
        chat.innerHTML = '';
        addBotMsg('Hi! I\'m your AI solar advisor. Enter your address to get started.');
        showStep(1);
        showToast('Reset');
      });

      // Bottom free chat
      function bindBottomChat() {
        const freeChatInput = document.getElementById('freeChatInput');
        const freeChatSendBtn = document.getElementById('freeChatSendBtn');
        function updateFreeChatSendState() {
          const hasText = (freeChatInput.value || '').trim().length > 0;
          freeChatSendBtn.disabled = !hasText;
        }
        function sendFreeChat() {
          const text = (freeChatInput.value || '').trim();
          if (!text) return;
          addUserMsg(text);
          freeChatInput.value = '';
          updateFreeChatSendState();
          setTimeout(() => addBotMsg('Got it. We\'ll factor this into the analysis.'), 350);
        }
        freeChatInput?.addEventListener('input', updateFreeChatSendState);
        freeChatInput?.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendFreeChat();
          }
        });
        freeChatSendBtn?.addEventListener('click', sendFreeChat);
      }
    </script>
  
  <!-- html2canvas for image export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      try { boot(); } catch (e) { console.error('boot failed', e); }
    });
  </script>
</body></html>