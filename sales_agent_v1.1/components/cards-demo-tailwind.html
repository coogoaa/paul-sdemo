<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Cards Demo (Tailwind, H5) - v1.2</title>
  <!-- Use same resources as generated-page-v1.4_en.html -->
  <link id="interCss" href="../vendor/inter/inter.css" rel="stylesheet" onerror="this.onerror=null; this.href='https://rsms.me/inter/inter.css'">
  <link rel="stylesheet" href="../vendor/tailwind/tailwind.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../vendor/lucide/lucide.min.js" onerror="this.onerror=null; this.src='https://unpkg.com/lucide@latest'"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    
    /* Map container styles */
    .map-container {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 75%; /* 4:3 aspect ratio */
      overflow: hidden;
      touch-action: none;
      background-color: #f9fafb;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
    }
    
    .map-viewport {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
      cursor: grab;
    }
    
    .map-viewport:active {
      cursor: grabbing;
    }
    
    .map-image {
      position: absolute;
      top: 50%;
      left: 50%;
      transform-origin: center center;
      will-change: transform;
      transition: transform 0.15s ease-out;
      max-width: none;
      height: auto;
      touch-action: none;
      user-select: none;
    }
    
    .map-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    /* Toolbar styles */
    .map-toolbar {
      position: absolute;
      bottom: 1rem;
      right: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      z-index: 10;
    }
    
    .map-toolbar button {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: white;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.15s ease;
      cursor: pointer;
      pointer-events: auto;
    }
    
    .map-toolbar button:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }
    
    .map-toolbar button:active {
      transform: scale(0.95);
    }
    
    .map-toolbar button.active {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }
    
    /* Roof selection pulse animation */
    @keyframes pulse {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.8;
      }
      70% {
        transform: translate(-50%, -50%) scale(1.05);
        opacity: 0.3;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.8;
      }
    }
    
    .roof-pulse {
      animation: pulse 2s infinite;
    }
    
    /* Coordinate label */
    .coord-label {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: rgba(255, 255, 255, 0.9);
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-family: 'Roboto Mono', monospace;
      color: #374151;
      border: 1px solid #e5e7eb;
      z-index: 10;
      pointer-events: none;
    }
    
    /* Back button */
    .back-button {
      position: absolute;
      top: 1rem;
      left: 1rem;
      z-index: 10;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.5rem 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #374151;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: all 0.15s ease;
      cursor: pointer;
    }
    
    .back-button:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }
    
    .back-button:active {
      transform: scale(0.98);
    }
    
    /* Loading animation for AI analysis */
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    
    /* Responsive adjustments */
    @media (max-width: 640px) {
      .map-toolbar {
        bottom: 0.75rem;
        right: 0.75rem;
      }
      
      .map-toolbar button {
        width: 2.25rem;
        height: 2.25rem;
        border-radius: 0.5rem;
      }
      
      .coord-label {
        font-size: 0.6875rem;
        padding: 0.125rem 0.5rem;
      }
      
      .back-button {
        padding: 0.375rem 0.625rem;
        font-size: 0.8125rem;
      }
    }
  </style>
</head>
<body class="bg-[#FAFFFE] text-gray-800 min-h-screen font-sans" style="font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft Yahei', 'Noto Sans', 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji';">
  <div class="mx-auto max-w-md min-h-screen flex flex-col items-stretch">
    <div class="px-3 pt-4 pb-2">
      <div class="text-[18px] font-semibold tracking-tight">Cards Demo · Tailwind (H5)</div>
      <div class="text-[12px] text-gray-600">Strictly aligned to generated-page-v1.4_en.html styles</div>
    </div>

    <main class="flex-1 px-3 pb-20 space-y-4">

      <!-- S5_COMPOSITE_CARD: 3D/2D + Plans + Value + CTA -->
      <section class="rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden">
        <div class="p-3">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <div class="inline-flex items-center gap-1.5 text-[11px] px-2 py-1 rounded-lg bg-emerald-50 text-emerald-700 border border-emerald-200">
                <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                <span>Analysis complete</span>
              </div>
              <div class="hidden sm:block text-[12px] text-gray-600">Usable area 82 m² · Max ~ 10.8 kW</div>
            </div>
            <div class="text-[11px] text-gray-500">Source: Satellite + Estimation</div>
          </div>

          <!-- Model placeholder (match Step4 aesthetics) -->
          <div class="relative rounded-xl overflow-hidden border border-green-200 bg-gray-50" style="height: 20vh;">
            <div class="absolute inset-0 flex items-center justify-center text-[12px] text-gray-500">3D/2D viewer placeholder</div>
            <div class="absolute top-2 left-2 text-[11px] px-2 py-1 rounded-md bg-gray-100 border border-gray-200">Drag to rotate</div>
          </div>

          <!-- Horizontal mini plan strip -->
          <div class="mt-3">
            <div class="text-[12px] text-gray-600 mb-2">Tailored plans</div>
            <div class="flex gap-2 overflow-x-auto no-scrollbar">
              <button class="shrink-0 rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left min-w-[46%]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-medium text-gray-800">Smart Saver</div>
                  <i data-lucide="zap" class="w-4.5 h-4.5 text-amber-500"></i>
                </div>
                <div class="text-[12px] text-gray-600 mt-1">6.6 kW · ¥X1–Y1</div>
              </button>
              <button class="shrink-0 rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left min-w-[46%]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-medium text-gray-800">High Efficiency</div>
                  <i data-lucide="gauge" class="w-4.5 h-4.5 text-gray-600"></i>
                </div>
                <div class="text-[12px] text-gray-600 mt-1">8.2 kW · ¥X2–Y2</div>
              </button>
              <button class="shrink-0 rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left min-w-[46%]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-medium text-gray-800">Energy Independence</div>
                  <i data-lucide="battery-charging" class="w-4.5 h-4.5 text-emerald-500"></i>
                </div>
                <div class="text-[12px] text-gray-600 mt-1">10.0 kW · ¥X3–Y3</div>
              </button>
              <button class="shrink-0 rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left min-w-[46%]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-medium text-gray-800">Ultimate Energy</div>
                  <i data-lucide="stars" class="w-4.5 h-4.5 text-amber-500"></i>
                </div>
                <div class="text-[12px] text-gray-600 mt-1">12.0 kW · ¥X4–Y4</div>
              </button>
            </div>
          </div>

          <!-- Budget/value panel -->
          <section class="mt-3 p-2.5 rounded-2xl bg-white border border-green-200 shadow-sm">
            <div class="flex items-center justify-between mb-1">
              <h3 class="text-[13px] font-semibold text-gray-900">System budget (incl. tax)</h3>
              <span class="text-[16px] font-bold text-[#22C55E]">$0 – $0</span>
            </div>
            <div class="grid grid-cols-2 gap-1.5 mb-1.5">
              <div class="rounded-xl border border-gray-100 p-2">
                <div class="text-[10px] text-gray-500">Estimated system size</div>
                <div class="text-[12px] font-semibold text-gray-900">–</div>
              </div>
              <div class="rounded-xl border border-gray-100 p-2">
                <div class="text-[10px] text-gray-500">Payback period</div>
                <div class="text-[12px] font-semibold text-gray-900">–</div>
              </div>
              <div class="rounded-xl border border-gray-100 p-2">
                <div class="text-[10px] text-gray-500">Self-consumption</div>
                <div class="text-[12px] font-semibold text-gray-900">–</div>
              </div>
              <div class="rounded-xl border border-gray-100 p-2">
                <div class="text-[10px] text-gray-500">Annual bill savings</div>
                <div class="text-[12px] font-semibold text-gray-900">–</div>
              </div>
            </div>
            <div class="flex items-center gap-1.5">
              <button class="px-2.5 py-1.5 text-[11px] rounded-xl border border-gray-200 bg-white">Copy</button>
              <button class="px-2.5 py-1.5 text-[11px] rounded-xl border border-gray-200 bg-white">Share</button>
              <button class="ml-auto px-2.5 py-1.5 text-[11px] rounded-xl bg-[#22C55E] text-white border border-[#22C55E] hover:bg-[#16A34A] transition">Get subsidy-inclusive quote</button>
            </div>
          </section>
        </div>
      </section>

      <!-- SHARE_CARD: Shareable summary card (for copy/share) -->
      <section class="rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden">
        <div class="p-3">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <div class="text-[13px] font-semibold text-gray-900">Shareable summary</div>
              <span class="hidden sm:inline text-[11px] text-gray-500">Preview</span>
            </div>
            <div class="flex items-center gap-1.5">
              <button class="px-2.5 py-1.5 text-[11px] rounded-xl border border-gray-200 bg-white hover:bg-gray-50 inline-flex items-center gap-1.5">
                <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                <span>Copy</span>
              </button>
              <button class="px-2.5 py-1.5 text-[11px] rounded-xl border border-gray-200 bg-white hover:bg-gray-50 inline-flex items-center gap-1.5">
                <i data-lucide="share-2" class="w-3.5 h-3.5"></i>
                <span>Share</span>
              </button>
              <button class="btn-export px-2.5 py-1.5 text-[11px] rounded-xl border border-gray-200 bg-white hover:bg-gray-50 inline-flex items-center gap-1.5" data-target="#shareCard">
                <i data-lucide="image-down" class="w-3.5 h-3.5"></i>
                <span>Save image</span>
              </button>
            </div>
          </div>

          <!-- Card body that can be exported as image later -->
          <div id="shareCard" class="rounded-xl border border-green-200 bg-white overflow-hidden">
            <!-- Top banner / optional image -->
            <div class="relative bg-gray-50 border-b border-green-100" style="aspect-ratio: 16/9;">
              <img src="../Pic/point_523_high.jpg" alt="roof" class="w-full h-full object-cover">
              <div class="absolute top-2 left-2 text-[11px] px-2 py-1 rounded-md bg-white/90 border border-gray-200 inline-flex items-center gap-1.5">
                <i data-lucide="map-pin" class="w-3.5 h-3.5"></i>
                <span id="shareAddr">Sample address, City</span>
              </div>
              <div class="absolute top-2 right-2 text-[11px] px-2 py-1 rounded-md bg-white/90 border border-gray-200">
                <span id="shareDate"></span>
              </div>
            </div>

            <div class="p-3">
              <div class="flex items-center justify-between">
                <div class="text-[16px] font-semibold text-gray-900" id="sharePlan">High Efficiency</div>
                <div class="text-[11px] text-gray-500">Solar Estimation</div>
              </div>

              <div class="mt-2 grid grid-cols-2 gap-1.5">
                <div class="rounded-xl border border-gray-100 p-2">
                  <div class="text-[10px] text-gray-500">System size</div>
                  <div class="text-[12px] font-semibold text-gray-900" id="shareSize">6.5 kW (≈ 16 panels)</div>
                </div>
                <div class="rounded-xl border border-gray-100 p-2">
                  <div class="text-[10px] text-gray-500">Budget (incl. tax)</div>
                  <div class="text-[12px] font-semibold text-gray-900" id="shareBudget">$X – $Y</div>
                </div>
                <div class="rounded-xl border border-gray-100 p-2">
                  <div class="text-[10px] text-gray-500">Payback</div>
                  <div class="text-[12px] font-semibold text-gray-900" id="shareROI">4–5 years</div>
                </div>
                <div class="rounded-xl border border-gray-100 p-2">
                  <div class="text-[10px] text-gray-500">Self-consumption</div>
                  <div class="text-[12px] font-semibold text-gray-900" id="shareSelfUse">60% – 72%</div>
                </div>
              </div>

              <div class="mt-2 flex items-center gap-2">
                <div class="flex-1 text-[11px] text-gray-600">
                  Scan for your AI-powered solar proposal tailored just for you.
                </div>
                <!-- QR/link placeholder -->
                <div class="shrink-0 h-16 w-16 rounded-md border border-gray-200 bg-white grid place-items-center">
                  <i data-lucide="qr-code" class="w-6 h-6 text-gray-500"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- SHARE_CARD_ALT: Split satellite + 3D preview card -->
      <section class="rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden">
        <div class="p-3">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <div class="text-[13px] font-semibold text-gray-900">Shareable summary</div>
            </div>
            
          </div>

          <div id="shareCard2" class="rounded-xl border border-green-200 bg-white overflow-hidden">
            <!-- Split banner -->
            <div class="grid grid-cols-2 border-b border-green-100">
              <!-- Satellite -->
              <div class="relative bg-gray-50" style="aspect-ratio: 16/9;">
                <img src="../Pic/weixing.png" alt="satellite" class="w-full h-full object-cover">
                <div class="absolute top-2 left-2 text-[11px] px-2 py-1 rounded-md bg-white/90 border border-gray-200 inline-flex items-center gap-1.5">
                  <i data-lucide="map-pin" class="w-3.5 h-3.5"></i>
                  <span id="shareAddr2">Sample address, City</span>
                </div>
              </div>
              <!-- 3D model preview (image placeholder) -->
              <div class="relative bg-gray-50" style="aspect-ratio: 16/9;">
                <img src="../Pic/3d.png" alt="3D model" class="w-full h-full object-cover">
                <div class="absolute top-2 right-2 text-[11px] px-2 py-1 rounded-md bg-white/90 border border-gray-200">3D preview</div>
              </div>
            </div>

            <div class="p-3">
              <div class="flex items-center justify-between">
                <div class="text-[16px] font-semibold text-gray-900" id="sharePlan2">High Efficiency</div>
                <div class="text-[11px] text-gray-500" id="shareDate2"></div>
              </div>
              <div class="mt-2 grid grid-cols-2 gap-1.5">
                <div class="rounded-xl border border-gray-100 p-2">
                  <div class="text-[10px] text-gray-500">System size</div>
                  <div class="text-[12px] font-semibold text-gray-900" id="shareSize2">6.5 kW (≈ 16 panels)</div>
                </div>
                <div class="rounded-xl border border-gray-100 p-2">
                  <div class="text-[10px] text-gray-500">Budget (incl. tax)</div>
                  <div class="text-[12px] font-semibold text-gray-900" id="shareBudget2">$X – $Y</div>
                </div>
                <div class="rounded-xl border border-gray-100 p-2">
                  <div class="text-[10px] text-gray-500">Payback</div>
                  <div class="text-[12px] font-semibold text-gray-900" id="shareROI2">4–5 years</div>
                </div>
                <div class="rounded-xl border border-gray-100 p-2">
                  <div class="text-[10px] text-gray-500">Self-consumption</div>
                  <div class="text-[12px] font-semibold text-gray-900" id="shareSelfUse2">60% – 72%</div>
                </div>
              </div>
              <div class="mt-2 flex items-center gap-2">
                <div class="flex-1 text-[11px] text-gray-600">
                  Scan for your AI-powered solar proposal tailored just for you.
                </div>
                <!-- QR/link placeholder -->
                <div class="shrink-0 h-16 w-16 rounded-md border border-gray-200 bg-white grid place-items-center">
                  <i data-lucide="qr-code" class="w-6 h-6 text-gray-500"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ANALYSIS_COMPLETE: duplicated from v1.5 for demo -->
      <section class="rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden">
        <div class="p-3">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2 text-[12px] text-emerald-600">
              <i data-lucide="check-circle-2" class="w-4.5 h-4.5"></i>
              <span>Analysis complete</span>
            </div>
            <div class="inline-flex items-center gap-1.5 text-[12px] text-gray-600 px-2 py-1 rounded-lg border border-gray-200">
              <i data-lucide="chevron-left" class="w-4 h-4"></i> Back
            </div>
          </div>
          <h3 class="text-[18px] tracking-tight font-semibold text-gray-800">Your 3D roof model</h3>
          <div class="mt-2 relative rounded-xl overflow-hidden border border-green-200 bg-gray-50" style="height: 20vh;">
            <div class="absolute inset-0">
              <model-viewer src="3d/43792833-0cb3-4884-85ef-1fb678777d5c/base_basic_shaded.glb" camera-controls auto-rotate disable-zoom ar style="width:100%;height:100%;background:transparent" class="absolute inset-0"></model-viewer>
              <div class="absolute top-2 left-2 text-[11px] px-2 py-1 rounded-md bg-gray-100 border border-gray-200">Drag to rotate</div>
            </div>
          </div>
          <div class="mt-3">
            <div class="text-[12px] text-gray-600 mb-2">Based on the analysis, here are 4 tailored plans</div>
            <div class="flex gap-2 overflow-x-auto no-scrollbar">
              <button class="scheme-card-mini shrink-0 rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left min-w-[46%]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-medium text-gray-800">Smart Saver</div>
                  <i data-lucide="zap" class="w-4.5 h-4.5 text-amber-500"></i>
                </div>
                <div class="text-[12px] text-gray-600 mt-1">Fewer panels, quick payback</div>
              </button>
              <button class="scheme-card-mini shrink-0 rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left min-w-[46%]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-medium text-gray-800">High Efficiency</div>
                  <i data-lucide="gauge" class="w-4.5 h-4.5 text-gray-600"></i>
                </div>
                <div class="text-[12px] text-gray-600 mt-1">More generation, higher self-use</div>
              </button>
              <button class="scheme-card-mini shrink-0 rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left min-w-[46%]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-medium text-gray-800">Energy Independence</div>
                  <i data-lucide="battery-charging" class="w-4.5 h-4.5 text-emerald-500"></i>
                </div>
                <div class="text-[12px] text-gray-600 mt-1">Battery backup for outages</div>
              </button>
              <button class="scheme-card-mini shrink-0 rounded-xl border border-green-200 bg-white hover:bg-gray-50 transition p-3 text-left min-w-[46%]">
                <div class="flex items-center justify-between">
                  <div class="text-[14px] font-medium text-gray-800">Ultimate Energy</div>
                  <i data-lucide="stars" class="w-4.5 h-4.5 text-amber-500"></i>
                </div>
                <div class="text-[12px] text-gray-600 mt-1">Max panels, maximum savings</div>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- L1 Large area lead card -->
      <section class="rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden">
        <div class="p-3">
          <div class="flex items-center justify-between mb-2">
            <div class="text-[13px] font-semibold text-gray-900">Large roof – custom design</div>
            <div class="inline-flex items-center gap-1.5 text-[11px] px-2 py-1 rounded-lg bg-amber-50 text-amber-700 border border-amber-200">Area &gt; 450 m²</div>
          </div>
          <ul class="list-disc pl-5 text-[12px] text-gray-600 space-y-1">
            <li>Dedicated engineer assessment</li>
            <li>Grid & export strategy</li>
            <li>Subsidy & policy review</li>
          </ul>
          <div class="mt-3 space-y-2">
            <div class="relative">
              <i data-lucide="user" class="w-4.5 h-4.5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
              <input placeholder="Name" class="w-full pl-10 pr-3 py-3 rounded-xl bg-gray-50 border border-gray-200 text-[14px] placeholder:text-gray-400 focus:outline-none focus:border-[#22C55E] transition"/>
            </div>
            <div class="relative">
              <i data-lucide="mail" class="w-4.5 h-4.5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
              <input type="email" placeholder="Email" class="w-full pl-10 pr-3 py-3 rounded-xl bg-gray-50 border border-gray-200 text-[14px] placeholder:text-gray-400 focus:outline-none focus:border-[#22C55E] transition"/>
            </div>
            <div class="relative">
              <i data-lucide="phone" class="w-4.5 h-4.5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
              <input inputmode="tel" placeholder="Phone" class="w-full pl-10 pr-3 py-3 rounded-xl bg-gray-50 border border-gray-200 text-[14px] placeholder:text-gray-400 focus:outline-none focus:border-[#22C55E] transition"/>
            </div>
          </div>
          <div class="mt-3 flex items-center justify-end gap-2">
            <button class="px-3 py-2.5 rounded-xl bg-white border border-gray-200 text-[12px] hover:bg-gray-100 inline-flex items-center gap-1.5">
              <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
              <span>Re-evaluate</span>
            </button>
            <button class="px-4 py-2.5 rounded-xl bg-[#22C55E] text-white border border-[#22C55E] hover:bg-[#16A34A] transition text-[12px]">Submit</button>
          </div>
        </div>
      </section>

      <!-- F1 Address fallback -->
      <section class="rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden">
        <div class="p-3 space-y-2">
          <div class="inline-flex items-center gap-1.5 text-[11px] px-2 py-1 rounded-lg bg-red-50 text-red-700 border border-red-200">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            <span>Address not found or low quality</span>
          </div>
          <div class="text-[12px] text-gray-600">Try a different spelling or a nearby landmark, or drag the map manually.</div>
          <div class="flex items-center gap-2">
            <button class="px-3 py-2 rounded-xl bg-white border border-gray-200 text-[12px]">Retry locate</button>
            <button class="px-3 py-2 rounded-xl bg-white border border-gray-200 text-[12px]">Manual drag</button>
            <button class="ml-auto px-3 py-2 rounded-xl bg-[#22C55E] text-white border border-[#22C55E] hover:bg-[#16A34A] transition text-[12px]">Contact human assessment</button>
          </div>
        </div>
      </section>

      <!-- F3 Small area (no upload) -->
      <section class="rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden">
        <div class="p-3 space-y-2">
          <div class="inline-flex items-center gap-1.5 text-[11px] px-2 py-1 rounded-lg bg-amber-50 text-amber-700 border border-amber-200">
            <i data-lucide="triangle-alert" class="w-4 h-4"></i>
            <span>Installable area may be too small</span>
          </div>
          <div class="text-[12px] text-gray-600">Zoom in and reselect your roof, or leave contact for free manual check.</div>
          <div class="flex items-center gap-2">
            <button class="px-3 py-2 rounded-xl bg-white border border-gray-200 text-[12px]">Reselect roof</button>
            <button class="ml-auto px-3 py-2 rounded-xl bg-[#22C55E] text-white border border-[#22C55E] hover:bg-[#16A34A] transition text-[12px]">Free manual assessment</button>
          </div>
        </div>
      </section>

      <!-- F4 Analysis timeout -->
      <section class="rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden">
        <div class="p-3 space-y-2">
          <div class="inline-flex items-center gap-1.5 text-[11px] px-2 py-1 rounded-lg bg-amber-50 text-amber-700 border border-amber-200">
            <i data-lucide="timer" class="w-4 h-4"></i>
            <span>Analysis timeout</span>
          </div>
          <div class="text-[12px] text-gray-600">Proceeding with conservative parameters. Will auto-refresh when ready.</div>
          <div class="flex items-center justify-end">
            <button class="px-3 py-2 rounded-xl bg-[#22C55E] text-white border border-[#22C55E] hover:bg-[#16A34A] transition text-[12px]">Continue</button>
          </div>
        </div>
      </section>

      <!-- S8 Lead form (generic) removed per request -->
      <section class="rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden">
        <div class="p-3">
          <div class="mb-2 flex items-center justify-between">
            <button id="backBtn" class="inline-flex items-center gap-1.5 text-[12px] text-gray-600 px-2 py-1 rounded-lg hover:bg-gray-100 border border-gray-200">
              <i data-lucide="chevron-left" class="w-4 h-4"></i> Back
            </button>
            <div id="coordLabel" class="text-[12px] text-gray-600 truncate max-w-[65%]">Lat/Lng 30.4804, 104.0351</div>
          </div>
          
          <div id="mapViewport" class="relative rounded-xl overflow-hidden border border-green-200 bg-gray-50" style="height: 52vw; max-height: 360px; touch-action: none;">
            <img id="mapImage" src="../Pic/point_523_high.jpg" alt="map" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 select-none" style="transform: translate(-50%, -50%) scale(1.6); transform-origin: center center; width: 160%; height: auto; max-width: none;">
            
            <svg id="roofOverlay" class="absolute inset-0 pointer-events-none w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
            
            <div class="absolute top-2 left-2 text-[11px] px-2 py-1 rounded-md bg-gray-100/90 border border-gray-200">Drag/zoom map, then tap your roof</div>
            <div class="absolute top-2 right-2 flex flex-col gap-1">
              <button id="zoomIn" class="h-8 w-8 rounded-lg bg-white/90 border border-gray-200 flex items-center justify-center shadow-sm hover:bg-gray-50">
                <i data-lucide="plus" class="w-4 h-4"></i>
              </button>
              <button id="zoomOut" class="h-8 w-8 rounded-lg bg-white/90 border border-gray-200 flex items-center justify-center shadow-sm hover:bg-gray-50">
                <i data-lucide="minus" class="w-4 h-4"></i>
              </button>
              <button id="rectSelect" class="h-8 w-8 rounded-lg bg-white/90 border border-gray-200 flex items-center justify-center shadow-sm hover:bg-gray-50">
                <i data-lucide="crop" class="w-4 h-4"></i>
              </button>
              <button id="resetView" class="h-8 w-8 rounded-lg bg-white/90 border border-gray-200 flex items-center justify-center shadow-sm hover:bg-gray-50">
                <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
              </button>
              <button id="undoAction" class="h-8 w-8 rounded-lg bg-white/90 border border-gray-200 flex items-center justify-center shadow-sm hover:bg-gray-50">
                <i data-lucide="undo-2" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
          
          <div class="mt-2 flex items-center justify-between">
            <div id="roofHint" class="text-[12px] text-gray-600">Tap your roof on the map</div>
            <button id="confirmRoofBtn" class="shrink-0 inline-flex items-center gap-1.5 text-[12px] px-3 py-2 rounded-xl bg-[#22C55E] text-white border border-[#22C55E] hover:bg-[#16A34A] transition disabled:opacity-40 disabled:cursor-not-allowed" disabled>
              <i data-lucide="check" class="w-4 h-4"></i> Confirm roof
            </button>
          </div>
        </div>
      </section>

      <!-- 4_AI_ANALYSIS: Integrated with animation -->
      <section class="rounded-2xl bg-white border border-green-200 shadow-lg shadow-green-100/50 overflow-hidden">
        <div class="p-3">
          <div class="flex items-center gap-2 text-[12px] text-gray-600">
            <i data-lucide="sparkles" class="w-4 h-4 text-amber-500"></i>
            <span>Analyzing</span>
          </div>
          <h3 class="mt-1 text-[18px] tracking-tight font-semibold text-gray-800">Smart analysis for your roof</h3>
          <p class="text-[12px] text-gray-600 mt-1">It's like magic!</p>
          
          <!-- Animation placeholder with system works image -->
          <div class="mt-3 rounded-xl border border-gray-200 bg-gray-50 overflow-hidden">
            <div class="w-full" style="aspect-ratio: 16/9;">
              <img src="../Pic/ How the System Works.png" alt="system analysis" class="w-full h-full object-cover">
            </div>
          </div>
          
          <div class="mt-3 space-y-2 text-[13px]">
            <div class="flex items-center gap-2 text-gray-600">
              <i data-lucide="check-circle" class="w-3.5 h-3.5 text-emerald-500"></i>
              <span>Analyzing roof area</span>
            </div>
            <div class="flex items-center gap-2 text-gray-600">
              <i data-lucide="check-circle" class="w-3.5 h-3.5 text-emerald-500"></i>
              <span>Evaluating sun exposure</span>
            </div>
            <div class="flex items-center gap-2 text-gray-600">
              <i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin text-amber-500"></i>
              <span>Scanning high-consumption devices</span>
            </div>
          </div>
          <div class="mt-2 text-[12px] text-gray-500">This typically takes 5–15 seconds depending on imagery quality.</div>
        </div>
      </section>

    </main>
  </div>

  <script>lucide.createIcons();</script>
  <script>
  (function(){
    // Map elements
    const mapViewport = document.getElementById('mapViewport');
    const mapImage = document.getElementById('mapImage');
    const roofOverlay = document.getElementById('roofOverlay');
    const zoomInBtn = document.getElementById('zoomIn');
    const zoomOutBtn = document.getElementById('zoomOut');
    const rectSelectBtn = document.getElementById('rectSelect');
    const resetViewBtn = document.getElementById('resetView');
    const undoActionBtn = document.getElementById('undoAction');
    const confirmRoofBtn = document.getElementById('confirmRoofBtn');
    const roofHint = document.getElementById('roofHint');
    const coordLabel = document.getElementById('coordLabel');
    
    if (!mapViewport || !mapImage || !roofOverlay) return;

    // State management
    const state = {
      scale: 1.6,
      tx: 0,
      ty: 0,
      isSelecting: false,
      isDragging: false,
      startPos: null,
      lastPos: null,
      pointers: new Map(),
      history: [],
      roofSelected: false,
      roofPoint: null,
      selectionRect: null
    };

    // Apply transform to map image
    function applyTransform() {
      mapImage.style.transform = `translate(${state.tx}px, ${state.ty}px) translate(-50%, -50%) scale(${state.scale})`;
      updateCoordLabel();
    }

    // Convert viewport pixel to SVG percentage (0..100)
    function pxToPct(pxX, pxY){
      const rect = mapViewport.getBoundingClientRect();
      return {
        x: (pxX / rect.width) * 100,
        y: (pxY / rect.height) * 100
      };
    }

    // Save current state to history
    function pushHistory() {
      state.history.push({
        scale: state.scale,
        tx: state.tx,
        ty: state.ty,
        overlayHTML: roofOverlay.innerHTML,
        roofSelected: state.roofSelected,
        roofPoint: state.roofPoint
      });
      if (state.history.length > 50) state.history.shift();
    }

    // Undo last action
    function undo() {
      const last = state.history.pop();
      if (!last) return;
      
      state.scale = last.scale;
      state.tx = last.tx;
      state.ty = last.ty;
      state.roofSelected = last.roofSelected;
      state.roofPoint = last.roofPoint;
      
      roofOverlay.innerHTML = last.overlayHTML;
      updateRoofHint();
      confirmRoofBtn.disabled = !state.roofSelected;
      applyTransform();
    }

    // Reset view to initial state
    function resetView() {
      pushHistory();
      state.scale = 1.6;
      state.tx = 0;
      state.ty = 0;
      state.isSelecting = false;
      state.roofSelected = false;
      state.roofPoint = null;
      
      rectSelectBtn.classList.remove('bg-[#22C55E]', 'text-white', 'border-[#22C55E]');
      roofOverlay.innerHTML = '';
      updateRoofHint();
      confirmRoofBtn.disabled = true;
      applyTransform();
    }

    // Zoom at specific point
    function zoomAt(factor, cx, cy) {
      pushHistory();
      
      // 计算新的缩放比例，限制在0.6到4倍之间
      const newScale = Math.min(4, Math.max(0.6, state.scale * factor));
      
      // 如果达到缩放限制，不进行平移
      if ((newScale >= 4 && factor > 1) || (newScale <= 0.6 && factor < 1)) {
        return;
      }
      // 以 (cx, cy) 为焦点进行缩放，考虑视口中心偏移（图像以视口中心为基准）
      const rect = mapViewport.getBoundingClientRect();
      const vx = cx - rect.width / 2; // 以视口中心为原点
      const vy = cy - rect.height / 2;
      const mapX = (vx - state.tx) / state.scale;
      const mapY = (vy - state.ty) / state.scale;
      state.scale = newScale;
      state.tx = vx - mapX * state.scale;
      state.ty = vy - mapY * state.scale;
      applyTransform();
    }

    // Update coordinate label
    function updateCoordLabel() {
      // Mock coordinates - in a real app, these would be calculated from the map projection
      const lat = 30.4804 + (Math.random() * 0.0001 - 0.00005);
      const lng = 104.0351 + (Math.random() * 0.0001 - 0.00005);
      coordLabel.textContent = `Lat/Lng ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
    }

    // Update roof hint text
    function updateRoofHint() {
      if (state.roofSelected) {
        roofHint.textContent = 'Roof position selected';
        roofHint.classList.remove('text-gray-600');
        roofHint.classList.add('text-emerald-600', 'font-medium');
      } else {
        roofHint.textContent = 'Tap your roof on the map';
        roofHint.classList.remove('text-emerald-600', 'font-medium');
        roofHint.classList.add('text-gray-600');
      }
    }

    // Draw roof selection at position
    function drawRoofAt(clientX, clientY) {
      const rect = mapViewport.getBoundingClientRect();
      const x = ((clientX - rect.left) / rect.width) * 100;
      const y = ((clientY - rect.top) / rect.height) * 100;
      const w = 20; // Roof width percentage
      const h = 15; // Roof height percentage
      
      // Create or update roof selection
      roofOverlay.innerHTML = `
        <rect x="${x - w/2}" y="${y - h/2}" 
              width="${w}" height="${h}" 
              rx="2" ry="2" 
              fill="rgba(16,185,129,0.30)" 
              stroke="rgba(110,231,183,0.9)" 
              stroke-width="1.2" class="roof-pulse"/>
      `;
      
      state.roofSelected = true;
      state.roofPoint = { x, y };
      updateRoofHint();
      confirmRoofBtn.disabled = false;
    }

    // Event handlers
    function onPointerDown(evt) {
      evt.preventDefault();
      const rect = mapViewport.getBoundingClientRect();
      const x = evt.clientX - rect.left;
      const y = evt.clientY - rect.top;
      
      state.isDragging = true;
      state.startPos = { x, y };
      state.lastPos = { x, y };
      
      // If in selection mode, start drawing selection
      if (state.isSelecting) {
        pushHistory();
        state.selectionRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        const p = pxToPct(x, y);
        state.selectionRect.setAttribute("x", p.x);
        state.selectionRect.setAttribute("y", p.y);
        state.selectionRect.setAttribute("width", "0");
        state.selectionRect.setAttribute("height", "0");
        state.selectionRect.setAttribute("stroke", "#3B82F6");
        state.selectionRect.setAttribute("stroke-width", "1.5");
        state.selectionRect.setAttribute("fill", "rgba(59, 130, 246, 0.15)");
        state.selectionRect.setAttribute("pointer-events", "none");
        roofOverlay.appendChild(state.selectionRect);
      }
      
      mapViewport.style.cursor = 'grabbing';
      mapViewport.setPointerCapture(evt.pointerId);
    }

    function onPointerMove(evt) {
      if (!state.isDragging) return;
      
      const rect = mapViewport.getBoundingClientRect();
      const x = evt.clientX - rect.left;
      const y = evt.clientY - rect.top;
      
      if (state.isSelecting && state.selectionRect) {
        // Update selection rectangle in percentage space
        const p0 = pxToPct(state.startPos.x, state.startPos.y);
        const p1 = pxToPct(x, y);
        const rx = Math.min(p0.x, p1.x);
        const ry = Math.min(p0.y, p1.y);
        const rw = Math.abs(p1.x - p0.x);
        const rh = Math.abs(p1.y - p0.y);
        state.selectionRect.setAttribute("x", rx);
        state.selectionRect.setAttribute("y", ry);
        state.selectionRect.setAttribute("width", rw);
        state.selectionRect.setAttribute("height", rh);
      } else {
        // Pan the map
        const dx = x - state.lastPos.x;
        const dy = y - state.lastPos.y;
        state.tx += dx;
        state.ty += dy;
        applyTransform();
      }
      
      state.lastPos = { x, y };
    }

    function onPointerUp(evt) {
      if (!state.isDragging) return;
      
      const rect = mapViewport.getBoundingClientRect();
      const x = evt.clientX - rect.left;
      const y = evt.clientY - rect.top;
      
      // Check if this was a click (minimal movement)
      const dx = x - state.startPos.x;
      const dy = y - state.startPos.y;
      const isClick = (dx * dx + dy * dy) < 25; // Within 5px
      
      if (isClick && !state.isSelecting) {
        // Single tap - add roof selection and a point marker
        pushHistory();
        drawRoofAt(evt.clientX, evt.clientY);
        const pct = pxToPct(x, y);
        const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        dot.setAttribute("cx", pct.x);
        dot.setAttribute("cy", pct.y);
        dot.setAttribute("r", 1.2);
        dot.setAttribute("fill", "#10B981");
        dot.setAttribute("stroke", "#A7F3D0");
        dot.setAttribute("stroke-width", "0.6");
        roofOverlay.appendChild(dot);
      }
      
      // Clean up selection mode
      if (state.isSelecting) {
        // 只在点击矩形选择按钮时保持选择模式
        // state.isSelecting = false;
        // rectSelectBtn.classList.remove('bg-[#22C55E]', 'text-white', 'border-[#22C55E]');
        
        // 处理矩形选择
        if (state.selectionRect) {
          const width = parseFloat(state.selectionRect.getAttribute('width') || '0');
          const height = parseFloat(state.selectionRect.getAttribute('height') || '0');
          
          if (width < 2 || height < 2) {
            // 矩形太小，移除
            if (roofOverlay.contains(state.selectionRect)) {
              roofOverlay.removeChild(state.selectionRect);
            }
          } else {
            // 矩形选择完成，创建屋顶选择
            const rx = parseFloat(state.selectionRect.getAttribute('x') || '0');
            const ry = parseFloat(state.selectionRect.getAttribute('y') || '0');
            
            // 创建屋顶选择
            roofOverlay.innerHTML = `
              <rect x="${rx}" y="${ry}" 
                    width="${width}" height="${height}" 
                    rx="2" ry="2" 
                    fill="rgba(16,185,129,0.30)" 
                    stroke="rgba(110,231,183,0.9)" 
                    stroke-width="1.2" class="roof-pulse"/>
            `;
            
            state.roofSelected = true;
            state.roofPoint = { 
              x: rx + width / 2, 
              y: ry + height / 2 
            };
            updateRoofHint();
            confirmRoofBtn.disabled = false;
            
            // 保存到历史记录
            pushHistory();
            
            // 退出选择模式
            state.isSelecting = false;
            rectSelectBtn.classList.remove('bg-emerald-500', 'border-emerald-500', 'text-white');
            rectSelectBtn.classList.add('bg-white/90', 'border-gray-200');
          }
          
          state.selectionRect = null;
        }
      }
      
      state.isDragging = false;
      state.startPos = null;
      state.lastPos = null;
      state.lastDist = null;
      state.pointers.clear();
      
      mapViewport.style.cursor = '';
      mapViewport.releasePointerCapture(evt.pointerId);
    }

    // Initialize the map
    function initMap() {
      // Set initial transform
      applyTransform();
      
      // Add event listeners
      zoomInBtn.addEventListener('click', () => {
        const rect = mapViewport.getBoundingClientRect();
        zoomAt(1.2, rect.width / 2, rect.height / 2);
      });
      
      zoomOutBtn.addEventListener('click', () => {
        const rect = mapViewport.getBoundingClientRect();
        zoomAt(1/1.2, rect.width / 2, rect.height / 2);
      });
      
      // Reset view button (undo按钮上方的按钮)
      resetViewBtn.addEventListener('click', () => {
        resetView();
        // 重置选择状态
        state.isSelecting = false;
        rectSelectBtn.classList.remove('bg-[#22C55E]', 'text-white', 'border-[#22C55E]');
        if (state.selectionRect) {
          roofOverlay.removeChild(state.selectionRect);
          state.selectionRect = null;
        }
      });
      
      // Undo button
      undoActionBtn.addEventListener('click', () => {
        undo();
      });
      
      // Toggle rectangle selection mode with explicit class management
      rectSelectBtn.addEventListener('click', () => {
        state.isSelecting = !state.isSelecting;
        if (state.isSelecting) {
          // active: emerald theme
          rectSelectBtn.classList.remove('bg-white/90', 'border-gray-200', 'text-gray-800');
          rectSelectBtn.classList.add('bg-emerald-500', 'border-emerald-500', 'text-white');
        } else {
          // inactive: back to neutral
          rectSelectBtn.classList.remove('bg-emerald-500', 'border-emerald-500', 'text-white');
          rectSelectBtn.classList.add('bg-white/90', 'border-gray-200');
          if (state.selectionRect) {
            roofOverlay.removeChild(state.selectionRect);
            state.selectionRect = null;
          }
        }
      });
      
      // 添加双击重置视图
      mapViewport.addEventListener('dblclick', (e) => {
        e.preventDefault();
        resetView();
      });
      
      // Handle pointer events
      mapViewport.addEventListener('pointerdown', onPointerDown);
      mapViewport.addEventListener('pointermove', onPointerMove);
      mapViewport.addEventListener('pointerup', onPointerUp);
      mapViewport.addEventListener('pointercancel', onPointerUp);
      
      // Prevent context menu on long press
      mapViewport.addEventListener('contextmenu', (e) => e.preventDefault());
      
      // Handle touch events to prevent page scroll
      mapViewport.addEventListener('touchmove', (e) => {
        if (state.isDragging) {
          e.preventDefault();
        }
      }, { passive: false });
      
      // Initialize roof hint
      updateRoofHint();
      
      // Initial coordinate update
      updateCoordLabel();
      
      // Confirm button click handler
      confirmRoofBtn.addEventListener('click', () => {
        // In a real app, this would trigger the next step
        alert('Roof position confirmed!');
      });
      
      // Back button click handler
      document.getElementById('backBtn')?.addEventListener('click', () => {
        // In a real app, this would go back to the previous step
        alert('Going back to previous step');
      });
    }
    
    // Initialize the map when the DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMap);
    } else {
      initMap();
    }
  })();
  </script>
  <!-- Utilities: export share cards as image -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    (function(){
      function bindExportButtons(){
        const buttons = document.querySelectorAll('.btn-export[data-target]');
        buttons.forEach(btn => {
          if (btn.__bound) return; btn.__bound = true;
          btn.addEventListener('click', async () => {
            const sel = btn.getAttribute('data-target');
            const node = document.querySelector(sel);
            if (!node) return;
            const old = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<span>Generating...</span>';
            try {
              const canvas = await html2canvas(node, { backgroundColor: '#ffffff', useCORS: true, scale: 2 });
              const a = document.createElement('a');
              const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
              a.href = canvas.toDataURL('image/png');
              a.download = `solar-summary-${ts}.png`;
              document.body.appendChild(a); a.click(); a.remove();
            } catch(err){
              console.error(err); alert('Failed to generate image. Please try again.');
            } finally {
              btn.disabled = false; btn.innerHTML = old;
            }
          });
        });
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => { try{ bindExportButtons(); if (window.lucide && lucide.createIcons) lucide.createIcons(); }catch(e){} });
      } else { try{ bindExportButtons(); if (window.lucide && lucide.createIcons) lucide.createIcons(); }catch(e){} }
    })();
  </script>
</body>
</html>
