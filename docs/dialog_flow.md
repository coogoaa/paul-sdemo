# 对话流程设计（含分支与兜底）

本文档基于 `prd/prd1.0.md` 与现有 Demo（`demo_html/`）整理，定义 H5 智能太阳能顾问的端到端对话流程、关键分支、兜底策略与埋点。

## 0. 总览

- 交互形态：Chatbot + 交互式卡片 + 实时 3D 模型
- 总目标：获取高质量留资（转换率最大化）
- 次目标：在 60 秒内给出可信的初步提案与收益预估（建立信任）

## 1. 主流程（Happy Path）

1) 欢迎与承诺（0-1 步）
- Bot：欢迎语 + 价值承诺（“60 秒探索您家的太阳能潜力”）
- 卡片：输入地址或使用定位（如可行）

2) 地址校验与地图确认（2-3 步）
- 行为：根据地址定位卫星图，用户点击/框选屋顶
- 模型：SAM 分割屋顶轮廓，记录像素坐标与比例尺
- Bot：提示“已定位，请确认屋顶区域”

3) AI 分析动画与期待值管理（4 步）
- 动画：✔ 屋顶面积分析；✔ 日照评估；✔ 高能耗设施扫描
- Bot：强化“已在为您准备定制方案”

4) 3D 初次呈现（5 步）
- 输出：还原 3D 屋顶与墙体（默认坡度 23°，楼层按策略判定）
- Bot：给出屋顶可用性与最大理论容量的简述

5) 方案互动（6 步）
- 卡片：四个预设方案（智慧节省/高效能源/能源独立/终极能源）
- 交互：切换方案 → 3D 面板布局、电池墙动态变化

6) 价值呈现（7 步）
- UI：动态数字展示“预计年节省”，下方卡片显示详单（发电量/自用率/上网收益等）

7) 留资转化（8 步）
- Bot：强调补贴与完整报告（强 Hook）
- 表单：姓名、电话/邮箱、首选联系时间、地址已带入

## 2. 关键分支逻辑

- 分支 A：楼层判断策略
  - A1 Solar API 可用 → 取高度估算楼层
  - A2 Street View 可用 → 抓取正面图由 LLM 判定（1/2 层）
  - A3 历史区域默认值 → 使用片区默认楼层并标注“估算”

- 分支 B：屋顶复杂度与可用面积系数 F_combined
  - B1 平面屋顶 → F=0.80
  - B2 简单屋顶（2-4 大坡面）→ F=0.50
  - B3 复杂屋顶（多小坡、老虎窗等）→ F=0.35

- 分支 C：是否已有光伏板
  - C1 无面板 → 进入“新装三方案”
  - C2 有面板 → 切至“储能升级”建议（不出具体报价，仅给收益区间与下一步勘探）

- 分支 D：高能耗设施识别（泳池/球场）
  - D1 命中 → 用户画像上调（高/超高能耗型），相应提升推荐容量与自用率假设
  - D2 未命中 → 按面积与默认行为参数估算

- 分支 E：容量与报价区间
  - 计算 N_max = (A_roof_proj × F_combined) / 1.9
  - 计算 P_max = N_max × 0.45 kW
  - 依据 P_max 给出 3-4 档推荐容量与报价区间（±10% 浮动）

## 3. 兜底策略（异常与低质输入）

- 兜底 1：地址无效/无法定位
  - Bot：
    - 文案 A：“没找到该地址，能否换一个写法或发送附近地标？”
    - 文案 B：“也可跳过自动定位，手动在地图上拖到您家附近位置。”
  - 操作：提供“重试定位 / 手动拖动地图 / 联系人工评估（留资）”按钮

- 兜底 2：卫星图像不清晰/非住宅
  - Bot：
    - 文案：“我需要更清晰的屋顶图来计算，您可放大后再圈选，或留下联系方式获取人工免费评估。”
  - 操作：允许用户上传自家屋顶截图（可选），或直接转留资

- 兜底 3：屋顶面积异常
  - 过大（>450 m²）：提示需要高级顾问定制，强引导留资
  - 过小（<20 m²）：提示可能不具备安装价值，引导重圈选或留资人工复核

- 兜底 4：3D 渲染失败
  - UI：降级为 2D 平面示意与参数列表
  - Bot：说明“模型生成异常，不影响方案计算”，继续方案互动并建议留资获取完整报告

- 兜底 5：已装面板但识别不确定
  - Bot：呈现两条路径的优劣对比（“当作新装试算” vs “仅做储能升级评估”）
  - 默认：推荐先看“储能升级”收益预估，再转留资

- 兜底 6：用户长期无响应/中断
  - N 秒无交互 → Bot 发提醒与“稍后获取报告”的一键留资卡

## 4. 逐步话术示例（可直接落地）

- 步 1 欢迎
  - “你好！我是你的 AI 太阳能顾问。输入地址，60 秒带你看清自家潜力。”

- 步 2 地图确认
  - “我已定位到该区域，请在地图上点击你的屋顶（或拖动框选）。”

- 步 3 分析动画
  - “正在分析屋顶面积 / 日照情况 / 高能耗设施…这就像魔法一样！”

- 步 4 3D 呈现
  - “分析完成！这是为你生成的 3D 模型。你的屋顶可用性很不错，我们来看看方案吧。”

- 步 5 方案互动
  - “我为你准备了 4 个配置档。点击任意卡片，3D 模型会实时变化。”

- 步 6 价值呈现
  - “在该方案下，预计年节省约 ¥X,XXX（含上网收益）。下方可查看详细计算假设。”

- 步 7 留资转化
  - “你可能还可申请约 ¥X,XXX 的政府补贴。想看包含补贴的最终价格吗？留下联系方式，我立刻把完整报告发给你。”

- 兜底示例：图像不清
  - “我需要更清晰的屋顶图来继续计算。你可以放大后重新圈选，或留下联系方式，我们提供人工免费评估。”

## 5. 计算与假设（用于文案一致性）

- 面板面积：1.9 m²/片；单片功率：0.45 kW
- 可用面积系数：0.80 / 0.50 / 0.35（随屋顶复杂度）
- 年均等效小时：4.18；电价：0.30 AUD/kWh；上网电价：0.07 AUD/kWh
- 自用率：无电池 30%，有电池 85%

## 6. 埋点与关键指标

- **核心转化**：提交留资（表单成功）
- **过程指标**：
  - 地址输入成功率 / 地图确认完成率
  - 屋顶分割成功率 / 3D 渲染成功率
  - 方案卡片点击率（各档位）
  - 留资表单触达率 / 打开率 / 放弃率
- **异常率**：各兜底触发次数（地址、图像、面积、3D 失败等）

## 7. 开发对接要点

- 前端：
  - 地图圈选与分割交互统一数据结构（像素坐标 + 比例尺）
  - 3D 渲染支持不同容量档位与电池墙可见性开关
- 后端/AI：
  - 屋顶复杂度与高能耗设施识别模型接口
  - 楼层判定三策略的优先级与回退逻辑
  - 计算与价格假设集中配置（州/领地可覆盖）

---

备注：本流程与 `prd/prd1.0.md` 的分支和兜底保持一致，可结合 `prd/chat.md` 的 7 步呈现文案直接落地实现。
