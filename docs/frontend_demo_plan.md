# 前端 Demo 实施规划（仅前端交互）

依据：`prd/prd1.0.md`、`prd/chat.md`、`docs/dialog_flow.md` 与 `prd/临时/linshi.md` 的补充信息。

## 1. 共识与约束

- **地图选型**：先用 Leaflet（免 Key），后续可切换 Google Maps。
  - 说明：Leaflet 本身不提供底图，需配置瓦片提供商。
  - 卫星底图：可采用 Esri World Imagery 作为演示用卫星图源（无需 Key，需保留 Attribution；仅限 Demo）。
- **3D 深度**：先做简化盒体 + 面板网格占位，观察效果后再决定是否增强或改为静态 2D 示意。
- **主题视觉**：沿用 `demo_html/demo_grey.html` 的灰色主题；暂无品牌色/Logo 也可后续替换。
- **价格与区间**：采用 ±10% 浮动；统一声明“演示用、非最终报价”。
- **补贴提示**：默认开启；金额为演示占位（可固定值或与容量线性关联的占位计算）。
- **留资字段**：姓名、电话/邮箱、首选联系时间；基础校验（必填、格式）。
- **本地化**：货币单位使用 AUD；仅中文文案。
- **兜底文案**：沿用 `docs/dialog_flow.md` 当前版本。
- **埋点**：不接 GA，采用 console 埋点占位，后续易于替换。

## 2. 目录与文件结构（建议）

- `sales_agent/`
  - `index.html` 主页面（灰色主题布局 + 各步骤容器）
  - `assets/`
    - `css/`
      - `base.css` 重置与基础变量（灰色主题）
      - `layout.css` 页框架（头部/主区/侧栏/底部）
      - `components.css` 组件（聊天气泡、按钮、卡片、进度条、表单、抽屉）
    - `js/`
      - `config.js` 可配置参数（地图源、计算参数、UI 开关、文案）
      - `state.js` 全局状态 + 有限状态机（步骤切换）
      - `ui.js` UI 渲染与 DOM 操作（消息、卡片、进度、抽屉）
      - `flows.js` 对话流程与分支策略（兜底逻辑）
      - `calc.js` 计算与假设（N_max、P_max、发电/自用/上网/收益）
      - `mock_map.js` 地图占位（Leaflet + Esri 卫星图；圈选/点击简化）
      - `mock_3d.js` 3D 占位（three.js 简化几何 + 面板网格）
      - `app.js` 入口（初始化、路由事件、埋点）
    - `img/` 图标与占位图
  - `README.md` 使用说明（本地打开即可）

## 3. 页面结构与交互（贴合 demo_grey 风格）

- **顶部**：标题 + 步骤进度条（1~7）。
- **左侧**：Chatbot 对话区（系统消息、用户输入/卡片）。
- **右侧**：可视化容器（随步骤切换）
  - Step2：地图圈选/点击屋顶（卫星底图）
  - Step3：分析动画（逐条打勾）
  - Step4：3D 模型视图（旋转/缩放）
  - Step5~6：方案卡片 + 价值数字滚动
- **底部**：留资抽屉（Step7 时弹出）

## 4. 分支与兜底（内置策略）

- 楼层判定：Solar API（未来）/ Street View（未来）/ 片区默认（当前以默认）
- 屋顶复杂度 F_combined：平面 0.80 / 简单 0.50 / 复杂 0.35（默认“简单”）
- 已有面板识别：演示为手工切换（不确定时提供“双路径”选择）
- 面积异常：>450 m² 或 <20 m² 触发兜底话术 + 留资引导
- 地图/3D 降级：地图失败 → 面积手输；3D 失败 → 2D 示意与参数列表

## 5. 计算与假设（与 PRD 对齐）

- 面板面积：1.9 m²/片；单片功率：0.45 kW
- 年均等效小时：4.18；电价：0.30 AUD/kWh；上网电价：0.07
- 自用率：无电池 30%，有电池 85%
- 公式：
  - `N_max = (A_roof_proj × F_combined) / 1.9`
  - `P_max = N_max × 0.45`
  - 年发电量、自用电量、上网电量、上网收益按 `docs/dialog_flow.md` 描述
- 报价区间：按方案容量计算基价后 ±10% 浮动；页面展示“演示用、非最终报价”提示。
- 补贴：默认展示“约 $XXXX”，为演示占位（可根据容量线性估算或固定示例）。

## 6. 文案与表单（演示版）

- 文案：采用 `docs/dialog_flow.md` 提供的话术（欢迎、分析、3D、方案、价值、留资与兜底）。
- 表单字段：姓名、电话/邮箱、首选联系时间（可选）；基础校验与错误提示。
- 本地化：货币为 AUD，数字格式化为本地风格（千分位）。

## 7. 埋点与可视化

- 埋点：console 输出事件（地址输入成功、圈选成功、分析完成、方案点击、进入留资、提交/放弃、兜底触发等）。
- 方便后续替换为 GA/其他统计，仅需更换 `analytics.js` 的实现。

## 8. 里程碑与验收

- M1：框架与布局（主题、步骤切换、对话框架）
- M2：地图与圈选占位（卫星底图 + 简化圈选/点击）
- M3：分析动画与 3D 占位（旋转/缩放 + 面板网格）
- M4：方案卡片联动计算与价值数字滚动
- M5：兜底分支与留资抽屉（校验）
- M6：整理 README 与演示脚本

验收标准：
- 能按 7 步走通；地图与 3D 有可视化反馈；两类分支可演示（已装/未装；面积异常）。
- 方案卡片切换可联动 3D 与价值数字；留资表单可本地记录（console）。

## 9. 风险与依赖

- 卫星瓦片稳定性与商用限制：Demo 阶段可用，正式需切换有授权的提供商（如 Google、Mapbox）。
- 低性能设备上的 3D 兼容性：需保留 2D 降级路径。

## 10. 待确认/开放项

- 是否使用 Esri World Imagery 作为卫星底图占位（默认：是，Demo 阶段）。
- 补贴数额策略：固定示例 vs 容量线性估算（默认：固定示例）。
- 方案档位数量：3 档或 4 档（`prd/chat.md` 提到 4 档，默认 4 档）。

---

如确认本规划，我将开始创建 `sales_agent/` 目录与上述文件骨架，并实现基础交互与占位效果。
